<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0a0e17">
    <meta name="background-color" content="#0a0e17">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MEGA FOREX">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="MEGA FOREX">
    <meta name="msapplication-TileColor" content="#0a0e17">
    <meta name="msapplication-navbutton-color" content="#3b82f6">
    <meta name="format-detection" content="telephone=no">

    <!-- App Icons - SVG for modern browsers, PNG fallbacks -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/static/icon.svg">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icon-192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/icon-192.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/static/icon-192.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/static/icon-192.png">
    <link rel="apple-touch-icon" href="/static/icon-192.png">

    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" href="/static/icon-512.png">

    <title>MEGA FOREX v9.2.2 PRO - AI Enhanced Trading Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a1f2e;
            --bg-hover: #252b3d;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --border-color: #374151;
            --gradient-bull: linear-gradient(135deg, #059669, #10b981);
            --gradient-bear: linear-gradient(135deg, #dc2626, #ef4444);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .logo span { color: var(--accent-green); }
        
        .header-stats {
            display: flex;
            gap: 2rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border-radius: 0.5rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Navigation */
        .nav-container {
            background: var(--bg-secondary);
            padding: 0.5rem 2rem;
            overflow-x: auto;
        }
        
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }
        
        .nav-tab {
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .nav-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .nav-tab.active {
            background: var(--accent-blue);
            color: white;
        }
        
        /* Main Content */
        .main-content {
            padding: 1.5rem 2rem;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Filters */
        .filters-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .filter-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        select, input {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        
        button {
            background: var(--accent-blue);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        button:hover {
            filter: brightness(1.1);
        }
        
        button.secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }
        
        /* Signal Cards */
        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1rem;
        }
        
        .signal-card {
            background: var(--bg-card);
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            padding: 1.25rem;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        /* BULLISH CARD - Green left border and subtle green glow */
        .signal-card.bullish-card {
            border-left: 4px solid var(--accent-green);
            box-shadow: inset 4px 0 20px rgba(16, 185, 129, 0.1);
        }
        
        .signal-card.bullish-card:hover {
            border-color: var(--accent-green);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2), inset 4px 0 20px rgba(16, 185, 129, 0.15);
        }
        
        /* BEARISH CARD - Red left border and subtle red glow */
        .signal-card.bearish-card {
            border-left: 4px solid var(--accent-red);
            box-shadow: inset 4px 0 20px rgba(239, 68, 68, 0.1);
        }
        
        .signal-card.bearish-card:hover {
            border-color: var(--accent-red);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.2), inset 4px 0 20px rgba(239, 68, 68, 0.15);
        }
        
        /* NEUTRAL CARD - Default styling */
        .signal-card.neutral-card {
            border-left: 4px solid var(--text-muted);
        }
        
        .signal-card:hover {
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .pair-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .pair-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .category-badge {
            font-size: 0.625rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .category-badge.major { background: var(--accent-blue); }
        .category-badge.cross { background: var(--accent-purple); }
        .category-badge.exotic { background: var(--accent-yellow); color: #000; }
        
        .composite-score {
            text-align: right;
        }
        
        .score-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .score-value.bullish { color: var(--accent-green); }
        .score-value.bearish { color: var(--accent-red); }
        .score-value.neutral { color: var(--text-secondary); }
        
        .stars {
            color: var(--accent-yellow);
            font-size: 0.875rem;
        }
        
        .direction-badge {
            display: inline-block;
            padding: 0.375rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .direction-badge.long {
            background: var(--gradient-bull);
            color: white;
        }
        
        .direction-badge.short {
            background: var(--gradient-bear);
            color: white;
        }
        
        .direction-badge.neutral {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }
        
        /* Statistics Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 0.5rem;
        }
        
        .stat-box {
            text-align: center;
        }
        
        .stat-box .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .stat-box .label {
            font-size: 0.625rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        /* Factor Grid — v9.0: 7 groups */
        .factor-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
            margin-bottom: 0.75rem;
        }

        .factor-item {
            text-align: center;
            padding: 0.3rem 0.15rem;
            border-radius: 0.25rem;
            font-size: 0.575rem;
            font-weight: 600;
        }

        .factor-item.bullish { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .factor-item.bearish { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .factor-item.neutral { background: var(--bg-hover); color: var(--text-secondary); }

        /* v9.0 Quality Gates */
        .gates-row {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .gate-badge {
            font-size: 0.55rem;
            font-weight: 600;
            padding: 0.15rem 0.35rem;
            border-radius: 0.2rem;
        }
        .gate-badge.pass { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .gate-badge.fail { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }

        /* v9.0 Conviction + Regime row */
        .v9-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.4rem 0.6rem;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 0.35rem;
            border: 1px solid rgba(139, 92, 246, 0.2);
            font-size: 0.7rem;
        }
        .regime-badge {
            padding: 0.15rem 0.4rem;
            border-radius: 0.2rem;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .regime-badge.trending { background: rgba(59, 130, 246, 0.25); color: #60a5fa; }
        .regime-badge.ranging { background: rgba(251, 191, 36, 0.25); color: #fbbf24; }
        .regime-badge.volatile { background: rgba(239, 68, 68, 0.25); color: #f87171; }
        .regime-badge.quiet { background: rgba(156, 163, 175, 0.25); color: #9ca3af; }
        
        /* Trade Setup */
        .trade-setup {
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        
        .setup-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .setup-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        
        .setup-item {
            text-align: center;
        }
        
        .setup-item .label {
            font-size: 0.625rem;
            color: var(--text-muted);
        }
        
        .setup-item .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .setup-item.entry .value { color: var(--accent-blue); }
        .setup-item.sl .value { color: var(--accent-red); }
        .setup-item.tp .value { color: var(--accent-green); }
        
        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .data-table th,
        .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
        }
        
        .data-table td {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }
        
        .data-table tr:hover {
            background: var(--bg-hover);
        }
        
        /* Analyzer */
        .analyzer-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
        }
        
        .pair-list {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1rem;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .pair-list-item {
            padding: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        
        .pair-list-item:hover,
        .pair-list-item.selected {
            background: var(--bg-hover);
        }
        
        .analyzer-detail {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        /* Charts */
        .chart-container {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        /* Weights Editor */
        .weights-editor {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        .weight-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .weight-label {
            width: 150px;
            font-weight: 500;
        }
        
        .weight-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        
        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-blue);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .weight-value {
            width: 60px;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        
        .weights-total {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .weights-total.valid { border: 2px solid var(--accent-green); }
        .weights-total.invalid { border: 2px solid var(--accent-red); }
        
        /* Audit */
        .audit-section {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .audit-section h3 {
            margin-bottom: 1rem;
            color: var(--accent-blue);
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-badge.ok { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .status-badge.limited { background: rgba(245, 158, 11, 0.2); color: var(--accent-yellow); }
        .status-badge.error { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        
        /* Calendar */
        .event-card {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--border-color);
        }
        
        .event-card.high { border-left-color: var(--accent-red); }
        .event-card.medium { border-left-color: var(--accent-yellow); }
        .event-card.low { border-left-color: var(--accent-green); }
        
        /* News */
        .news-item {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .news-headline {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .news-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Positioning */
        .position-bar {
            display: flex;
            height: 24px;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .position-long {
            background: var(--gradient-bull);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .position-short {
            background: var(--gradient-bear);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Backtest */
        .backtest-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .backtest-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .result-card {
            background: var(--bg-card);
            padding: 1.25rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        
        .result-card .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .result-card .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Refresh Timer */
        .refresh-timer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* ═══════════════════════════════════════════════════════════════════════════
           MOBILE RESPONSIVE DESIGN - App-like experience
           ═══════════════════════════════════════════════════════════════════════════ */
        
        /* Mobile First - Base styles for small screens */
        @media (max-width: 768px) {
            /* Header - Compact mobile header */
            .header {
                flex-direction: column;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .logo {
                font-size: 1.25rem;
            }
            
            .header-stats {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 0.5rem;
                width: 100%;
            }
            
            .stat-item {
                background: var(--bg-card);
                padding: 0.5rem;
                border-radius: 0.5rem;
            }
            
            .stat-value {
                font-size: 1rem;
            }
            
            .stat-label {
                font-size: 0.65rem;
            }
            
            .connection-status {
                padding: 0.4rem 0.75rem;
                font-size: 0.75rem;
            }
            
            .refresh-timer {
                font-size: 0.75rem;
            }
            
            /* Navigation - Horizontal scroll on mobile */
            .nav-container {
                padding: 0.5rem;
                position: sticky;
                top: 120px;
                z-index: 99;
                -webkit-overflow-scrolling: touch;
            }
            
            .nav-tabs {
                gap: 0.25rem;
                padding-bottom: 0.25rem;
            }
            
            .nav-tab {
                padding: 0.6rem 0.75rem;
                font-size: 0.75rem;
                min-width: fit-content;
            }
            
            /* Main Content - Full width on mobile */
            .main-content {
                padding: 0.75rem;
            }
            
            /* Filters - Stack vertically on mobile */
            .filters-bar {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .filter-group {
                width: 100%;
                justify-content: space-between;
            }
            
            .filter-group select {
                flex: 1;
                min-width: 0;
            }
            
            /* Signal Cards - Single column, touch optimized */
            .signals-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            .signal-card {
                padding: 1rem;
                touch-action: manipulation;
            }
            
            .signal-header {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .pair-name {
                font-size: 1.1rem;
            }
            
            .direction-badge {
                padding: 0.3rem 0.6rem;
                font-size: 0.7rem;
            }
            
            .score-circle {
                width: 50px;
                height: 50px;
                font-size: 1rem;
            }
            
            .signal-details {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .detail-item {
                padding: 0.5rem;
            }
            
            .detail-value {
                font-size: 0.85rem;
            }
            
            .detail-label {
                font-size: 0.65rem;
            }
            
            /* Factors Grid - 3 columns on mobile */
            .factors-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.25rem;
            }
            
            .factor-item {
                padding: 0.4rem;
                font-size: 0.65rem;
            }
            
            .factor-score {
                font-size: 0.75rem;
            }
            
            /* Tables - Responsive scroll */
            .data-table {
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                font-size: 0.8rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 0.5rem;
                white-space: nowrap;
            }
            
            /* Analyzer - Stack vertically */
            .analyzer-container {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            
            /* Result Cards - 2 columns */
            .backtest-results {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .result-card {
                padding: 0.75rem;
            }
            
            .result-card .value {
                font-size: 1.1rem;
            }
            
            .result-card .label {
                font-size: 0.65rem;
            }
            
            /* Journal Form - Stack inputs */
            .journal-form {
                grid-template-columns: 1fr;
            }
            
            /* Buttons - Touch friendly */
            button {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                min-height: 44px;
            }
            
            select, input {
                padding: 0.75rem;
                font-size: 0.9rem;
                min-height: 44px;
            }
            
            /* Audit Section */
            .audit-section {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
            
            .audit-section h3 {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }
            
            /* Charts */
            canvas {
                max-width: 100%;
                height: auto !important;
            }
            
            /* Modal/Overlay adjustments */
            .loading {
                padding: 2rem 1rem;
            }
            
            .spinner {
                width: 32px;
                height: 32px;
            }
        }
        
        /* Extra small screens (phones in portrait) */
        @media (max-width: 480px) {
            .header-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-tab {
                padding: 0.5rem 0.6rem;
                font-size: 0.7rem;
            }
            
            .signal-details {
                grid-template-columns: 1fr;
            }
            
            .factors-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .backtest-results {
                grid-template-columns: 1fr;
            }
            
            h2 {
                font-size: 1.1rem;
            }
        }
        
        /* Tablet landscape */
        @media (min-width: 769px) and (max-width: 1024px) {
            .signals-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header-stats {
                gap: 1.5rem;
            }
        }

        /* ═══════════════════════════════════════════════════════════════════════════
           NATIVE APP ENHANCEMENTS - iOS & Android optimizations
           ═══════════════════════════════════════════════════════════════════════════ */

        /* Safe Area Support for Notched Devices */
        @supports (padding: env(safe-area-inset-top)) {
            .header {
                padding-top: calc(0.75rem + env(safe-area-inset-top));
            }

            .main-content {
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }

            .mobile-bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Smooth scrolling & native feel */
        html {
            scroll-behavior: smooth;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            overscroll-behavior-y: contain;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Mobile Bottom Navigation Bar - Scrollable with all 10 tabs */
        .mobile-bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(17, 24, 39, 0.95);
            border-top: 1px solid var(--border-color);
            z-index: 1000;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .mobile-bottom-nav .nav-items {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 0.5rem 0;
        }

        .mobile-bottom-nav .nav-items::-webkit-scrollbar {
            display: none;
        }

        .mobile-bottom-nav .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 70px;
            padding: 0.5rem 0.75rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.65rem;
            transition: all 0.2s ease;
            cursor: pointer;
            border-radius: 0.5rem;
            flex-shrink: 0;
        }

        .mobile-bottom-nav .nav-item:active {
            transform: scale(0.95);
            background: var(--bg-hover);
        }

        .mobile-bottom-nav .nav-item.active {
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.15);
        }

        .mobile-bottom-nav .nav-item .nav-icon {
            font-size: 1.25rem;
            margin-bottom: 0.2rem;
        }

        .mobile-bottom-nav .nav-item .nav-label {
            white-space: nowrap;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .mobile-bottom-nav {
                display: block;
            }

            /* Hide regular nav on mobile */
            .nav-container {
                display: none;
            }

            /* CRITICAL: Large bottom padding for nav bar visibility */
            .main-content,
            .tab-content,
            #tab-overview,
            #tab-rates,
            #tab-analyzer,
            #tab-technical,
            #tab-positioning,
            #tab-news,
            #tab-calendar,
            #tab-weights,
            #tab-audit,
            #tab-api-status {
                padding-bottom: 120px !important;
            }

            /* ══════════════════════════════════════════════════════════════
               ALL TABLES - Base mobile styles
               ══════════════════════════════════════════════════════════════ */
            .data-table {
                display: table !important;
                width: 100% !important;
                table-layout: auto !important;
                font-size: 0.65rem !important;
                overflow-x: visible !important;
            }

            .data-table th, .data-table td {
                padding: 0.3rem 0.15rem !important;
                font-size: 0.6rem !important;
                white-space: normal !important;
                word-break: break-word !important;
                max-width: none !important;
            }

            /* ══════════════════════════════════════════════════════════════
               RATES TABLE - 5 columns compressed
               ══════════════════════════════════════════════════════════════ */
            #tab-rates table {
                font-size: 0.6rem !important;
            }

            #tab-rates th, #tab-rates td {
                padding: 0.25rem 0.1rem !important;
            }

            /* ══════════════════════════════════════════════════════════════
               PAIR ANALYZER - Compact layout
               ══════════════════════════════════════════════════════════════ */
            #tab-analyzer {
                padding: 0.5rem !important;
            }

            #tab-analyzer select {
                width: 100% !important;
                font-size: 0.8rem !important;
                margin-bottom: 0.5rem !important;
            }

            #tab-analyzer table {
                font-size: 0.7rem !important;
            }

            #tab-analyzer th, #tab-analyzer td {
                padding: 0.4rem 0.2rem !important;
            }

            /* ══════════════════════════════════════════════════════════════
               TECHNICAL INDICATORS - Fit 6+ columns
               ══════════════════════════════════════════════════════════════ */
            #tab-technical table {
                font-size: 0.55rem !important;
            }

            #tab-technical th, #tab-technical td {
                padding: 0.2rem 0.1rem !important;
            }

            /* ══════════════════════════════════════════════════════════════
               POSITIONING - Compact
               ══════════════════════════════════════════════════════════════ */
            #tab-positioning table {
                font-size: 0.6rem !important;
            }

            #tab-positioning th, #tab-positioning td {
                padding: 0.25rem 0.1rem !important;
            }

            /* ══════════════════════════════════════════════════════════════
               NEWS - Clickable + visible
               ══════════════════════════════════════════════════════════════ */
            #tab-news {
                padding: 0.5rem !important;
            }

            #tab-news .news-item {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
                border-radius: 8px !important;
                background: var(--bg-card) !important;
            }

            /* ══════════════════════════════════════════════════════════════
               CALENDAR - Compact 8 columns
               ══════════════════════════════════════════════════════════════ */
            #tab-calendar {
                padding: 0.25rem !important;
                overflow-x: hidden !important;
            }

            #tab-calendar table {
                font-size: 0.5rem !important;
                width: 100% !important;
                table-layout: fixed !important;
            }

            #tab-calendar th, #tab-calendar td {
                padding: 0.2rem 0.05rem !important;
                font-size: 0.5rem !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }

            /* Hide some columns on very small screens */
            #tab-calendar th:nth-child(7),
            #tab-calendar td:nth-child(7) {
                display: none;
            }

            /* ══════════════════════════════════════════════════════════════
               WEIGHTS - All buttons visible
               ══════════════════════════════════════════════════════════════ */
            #tab-weights {
                padding: 0.5rem !important;
                padding-bottom: 140px !important;
            }

            #tab-weights button {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.75rem !important;
                min-height: 40px !important;
            }

            /* ══════════════════════════════════════════════════════════════
               AUDIT - Fit columns
               ══════════════════════════════════════════════════════════════ */
            #tab-audit {
                padding: 0.5rem !important;
            }

            #tab-audit table {
                font-size: 0.55rem !important;
            }

            #tab-audit th, #tab-audit td {
                padding: 0.2rem 0.1rem !important;
            }

            #tab-audit .audit-section {
                padding: 0.5rem !important;
                margin-bottom: 0.5rem !important;
            }

            #tab-audit h3, #tab-audit h4 {
                font-size: 0.85rem !important;
            }

            /* ══════════════════════════════════════════════════════════════
               API STATUS - All content visible
               ══════════════════════════════════════════════════════════════ */
            #tab-api-status {
                padding: 0.5rem !important;
                padding-bottom: 140px !important;
            }

            #tab-api-status .api-card,
            #tab-api-status .status-card {
                padding: 0.5rem !important;
                font-size: 0.7rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* ══════════════════════════════════════════════════════════════
               PAIR ANALYZER DETAIL - Full mobile responsive
               ══════════════════════════════════════════════════════════════ */
            #analyzer-detail {
                padding: 0.5rem !important;
                overflow-x: hidden !important;
            }

            #analyzer-detail h3 {
                font-size: 1rem !important;
                margin-bottom: 0.5rem !important;
            }

            #analyzer-detail h4 {
                font-size: 0.8rem !important;
                margin: 0.5rem 0 0.25rem !important;
            }

            /* Convert 2-column grids to single column */
            #analyzer-detail > div[style*="grid-template-columns: 1fr 1fr"],
            #tab-analyzer [style*="grid-template-columns: 1fr 1fr"] {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 0.5rem !important;
            }

            /* Convert 3-column grids to 3 columns but smaller */
            #analyzer-detail [style*="repeat(3, 1fr)"],
            #tab-analyzer [style*="repeat(3, 1fr)"] {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 0.25rem !important;
            }

            /* Convert 5-column setup grid to 2 rows */
            #analyzer-detail .setup-grid,
            #analyzer-detail [style*="repeat(5, 1fr)"] {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 0.25rem !important;
            }

            /* Trade setup styling */
            #analyzer-detail .trade-setup {
                padding: 0.5rem !important;
            }

            #analyzer-detail .setup-item {
                padding: 0.3rem !important;
            }

            #analyzer-detail .setup-item .label {
                font-size: 0.55rem !important;
            }

            #analyzer-detail .setup-item .value {
                font-size: 0.65rem !important;
            }

            /* Result cards in analyzer */
            #analyzer-detail .result-card {
                padding: 0.4rem !important;
            }

            #analyzer-detail .result-card .value {
                font-size: 0.9rem !important;
            }

            #analyzer-detail .result-card .label {
                font-size: 0.55rem !important;
            }

            /* Market context row */
            #analyzer-detail [style*="justify-content: center"][style*="flex-wrap"] {
                gap: 0.5rem !important;
                padding: 0.5rem !important;
                justify-content: space-around !important;
            }

            #analyzer-detail [style*="justify-content: center"] > div {
                min-width: auto !important;
            }

            #analyzer-detail [style*="justify-content: center"] [style*="font-size: 0.7rem"] {
                font-size: 0.5rem !important;
            }

            /* ══════════════════════════════════════════════════════════════
               HOLDING PERIOD - 4 columns to 2x2 grid
               ══════════════════════════════════════════════════════════════ */
            #analyzer-detail [style*="linear-gradient"][style*="139, 92, 246"] {
                padding: 0.5rem !important;
            }

            #analyzer-detail [style*="linear-gradient"][style*="139, 92, 246"] > div[style*="repeat(4, 1fr)"] {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5rem !important;
            }

            #analyzer-detail [style*="linear-gradient"][style*="139, 92, 246"] [style*="text-align: center"][style*="padding: 0.75rem"] {
                padding: 0.4rem !important;
            }

            #analyzer-detail [style*="linear-gradient"][style*="139, 92, 246"] [style*="font-size: 1.5rem"],
            #analyzer-detail [style*="linear-gradient"][style*="139, 92, 246"] [style*="font-size: 1rem"] {
                font-size: 0.85rem !important;
            }

            #analyzer-detail [style*="linear-gradient"][style*="139, 92, 246"] [style*="font-size: 0.7rem"] {
                font-size: 0.5rem !important;
            }

            /* Holding period factors badges */
            #analyzer-detail [style*="linear-gradient"][style*="139, 92, 246"] [style*="flex-wrap: wrap"][style*="justify-content: center"] {
                gap: 0.25rem !important;
                padding-top: 0.5rem !important;
            }

            #analyzer-detail [style*="linear-gradient"][style*="139, 92, 246"] [style*="font-size: 0.75rem"][style*="padding: 0.3rem"] {
                font-size: 0.55rem !important;
                padding: 0.2rem 0.4rem !important;
            }

            /* Holding period recommendation box */
            #analyzer-detail [style*="linear-gradient"][style*="139, 92, 246"] [style*="margin-top: 1rem"][style*="text-align: center"] {
                margin-top: 0.5rem !important;
                padding: 0.5rem !important;
            }

            #analyzer-detail [style*="linear-gradient"][style*="139, 92, 246"] [style*="font-size: 0.85rem"] {
                font-size: 0.65rem !important;
            }

            /* ══════════════════════════════════════════════════════════════
               CALENDAR - Show Forecast/Previous/Actual properly
               ══════════════════════════════════════════════════════════════ */
            #calendar-container {
                overflow-x: hidden !important;
            }

            /* Hide countdown column (8th) on mobile to make space */
            #tab-calendar th:nth-child(8),
            #tab-calendar td:nth-child(8) {
                display: none !important;
            }

            /* Show Actual column back (was hidden) */
            #tab-calendar th:nth-child(7),
            #tab-calendar td:nth-child(7) {
                display: table-cell !important;
                font-size: 0.45rem !important;
                padding: 0.1rem !important;
            }

            /* Compact calendar table */
            #tab-calendar table {
                font-size: 0.45rem !important;
                width: 100% !important;
                table-layout: fixed !important;
            }

            #tab-calendar th, #tab-calendar td {
                padding: 0.15rem 0.05rem !important;
                font-size: 0.45rem !important;
                word-break: break-word !important;
            }

            /* Calendar column widths - flag emoji needs space */
            #tab-calendar th:nth-child(1),
            #tab-calendar td:nth-child(1) { width: 11% !important; } /* Time */
            #tab-calendar th:nth-child(2),
            #tab-calendar td:nth-child(2) { width: 14% !important; font-size: 0.55rem !important; } /* Currency - larger for flag */
            #tab-calendar th:nth-child(3),
            #tab-calendar td:nth-child(3) { width: 7% !important; } /* Impact */
            #tab-calendar th:nth-child(4),
            #tab-calendar td:nth-child(4) { width: 28% !important; } /* Event */
            #tab-calendar th:nth-child(5),
            #tab-calendar td:nth-child(5) { width: 13% !important; } /* Forecast */
            #tab-calendar th:nth-child(6),
            #tab-calendar td:nth-child(6) { width: 13% !important; } /* Previous */
            #tab-calendar th:nth-child(7),
            #tab-calendar td:nth-child(7) { width: 14% !important; } /* Actual */

            /* Calendar currency cell - show flag properly */
            #tab-calendar td:nth-child(2) > div {
                flex-direction: column !important;
                gap: 0 !important;
                align-items: flex-start !important;
            }

            #tab-calendar td:nth-child(2) span[style*="font-size: 1.25rem"] {
                font-size: 0.9rem !important;
            }

            /* Calendar header */
            #tab-calendar > div:first-child {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }

            #tab-calendar h2 {
                font-size: 1rem !important;
            }

            #tab-calendar .filter-group {
                flex-wrap: wrap !important;
            }

            #tab-calendar .filter-group select {
                font-size: 0.7rem !important;
                padding: 0.25rem !important;
            }

            /* Calendar legend - compact */
            #tab-calendar > div[style*="display: flex"][style*="gap: 2rem"] {
                gap: 0.5rem !important;
                flex-wrap: wrap !important;
                padding: 0.5rem !important;
                font-size: 0.65rem !important;
            }

            /* Data source badge */
            #calendar-container > div[style*="inline-flex"] {
                font-size: 0.6rem !important;
                padding: 0.3rem 0.5rem !important;
                flex-wrap: wrap !important;
            }

            /* ══════════════════════════════════════════════════════════════
               AUDIT - All grids responsive, no horizontal scroll
               ══════════════════════════════════════════════════════════════ */
            #audit-container {
                overflow-x: hidden !important;
            }

            /* Convert 4-column grids to 2 columns */
            #tab-audit [style*="repeat(4, 1fr)"],
            #audit-container [style*="repeat(4, 1fr)"] {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5rem !important;
            }

            /* Convert 3-column grids to 3 smaller columns */
            #tab-audit [style*="repeat(3, 1fr)"],
            #audit-container [style*="repeat(3, 1fr)"] {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 0.25rem !important;
            }

            /* Audit result cards */
            #tab-audit .result-card,
            #audit-container .result-card {
                padding: 0.4rem !important;
            }

            #tab-audit .result-card .value,
            #audit-container .result-card .value {
                font-size: 0.85rem !important;
            }

            #tab-audit .result-card .label,
            #audit-container .result-card .label {
                font-size: 0.5rem !important;
            }

            /* Audit tables - compress */
            #tab-audit table,
            #audit-container table {
                font-size: 0.5rem !important;
                width: 100% !important;
                table-layout: auto !important;
            }

            #tab-audit th, #tab-audit td,
            #audit-container th, #audit-container td {
                padding: 0.2rem 0.1rem !important;
                font-size: 0.5rem !important;
                word-break: break-word !important;
            }

            /* Audit tables - show all columns but compress further */
            #tab-audit table,
            #audit-container table {
                font-size: 0.45rem !important;
            }

            /* Quality checks badges - wrap */
            #tab-audit [style*="flex-wrap: wrap"][style*="gap: 0.5rem"],
            #audit-container [style*="flex-wrap: wrap"] {
                gap: 0.25rem !important;
            }

            #tab-audit [style*="flex-wrap"] span[style*="padding"],
            #audit-container [style*="flex-wrap"] span[style*="padding"] {
                padding: 0.15rem 0.4rem !important;
                font-size: 0.6rem !important;
            }

            /* Data quality legend */
            #tab-audit [style*="background: var(--bg-tertiary)"],
            #audit-container [style*="background: var(--bg-tertiary)"] {
                font-size: 0.55rem !important;
                padding: 0.4rem !important;
            }

            /* Conviction info box */
            #audit-container [style*="padding: 0.75rem"][style*="border-radius: 8px"] {
                padding: 0.4rem !important;
                font-size: 0.55rem !important;
            }

            /* Factor data sources */
            #audit-container [style*="font-size: 0.85rem"][style*="line-height"] {
                font-size: 0.55rem !important;
            }

            /* Features badges */
            #tab-audit [style*="flex-wrap"] span[style*="background: var(--bg-tertiary)"] {
                padding: 0.15rem 0.4rem !important;
                font-size: 0.55rem !important;
            }

            /* Methodology tables */
            #audit-container .audit-section table {
                font-size: 0.5rem !important;
            }

            #audit-container .audit-section th,
            #audit-container .audit-section td {
                padding: 0.15rem 0.1rem !important;
            }

            /* Scoring methodology text */
            #audit-container p[style*="color: var(--text-secondary)"] {
                font-size: 0.6rem !important;
                line-height: 1.4 !important;
            }

            /* Status badges smaller */
            .status-badge {
                font-size: 0.45rem !important;
                padding: 0.1rem 0.25rem !important;
            }
        }

        /* PWA Install Banner */
        .install-banner {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 2rem);
            max-width: 400px;
            background: linear-gradient(135deg, #1a1f2e, #0a0e17);
            border: 1px solid var(--accent-blue);
            border-radius: 1rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .install-banner.ios-banner {
            flex-direction: row;
            align-items: center;
        }

        .install-banner-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .install-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
        }

        .install-text {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .install-text strong {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .install-text span {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .install-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .install-btn-primary {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .install-btn-primary:hover {
            background: #2563eb;
        }

        .install-btn-dismiss {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .install-btn-dismiss:hover {
            background: var(--bg-hover);
        }

        @media (max-width: 768px) {
            .install-banner {
                bottom: 100px;
                width: calc(100% - 1rem);
                margin: 0 0.5rem;
            }
        }

        /* App Splash Screen */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .splash-screen.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .splash-logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 1rem;
        }

        .splash-logo span {
            color: var(--accent-green);
        }

        .splash-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }

        .splash-loader {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Pull to Refresh Visual Indicator */
        .pull-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: var(--accent-blue);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0 0 0.5rem 0.5rem;
            font-size: 0.8rem;
            z-index: 1001;
            transition: transform 0.3s ease;
        }

        .pull-indicator.visible {
            transform: translateX(-50%) translateY(0);
        }

        /* Touch-optimized Cards */
        @media (max-width: 768px) {
            .signal-card {
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

            .signal-card:active {
                transform: scale(0.98);
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }
        }

        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .signal-card:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
            
            .nav-tab:active {
                transform: scale(0.95);
            }
            
            button:active {
                transform: scale(0.95);
            }
            
            /* Larger touch targets */
            .nav-tab {
                min-height: 44px;
            }
            
            /* Remove hover effects on touch */
            .signal-card:hover {
                transform: none;
            }
        }
        
        /* Safe area for notched phones */
        @supports (padding: max(0px)) {
            .header {
                padding-left: max(1rem, env(safe-area-inset-left));
                padding-right: max(1rem, env(safe-area-inset-right));
            }
            
            .main-content {
                padding-left: max(0.75rem, env(safe-area-inset-left));
                padding-right: max(0.75rem, env(safe-area-inset-right));
                padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
            }
        }
        
        /* PWA Standalone mode */
        @media (display-mode: standalone) {
            .header {
                padding-top: max(0.75rem, env(safe-area-inset-top));
            }
        }
        
        /* Dark mode enhancements for OLED screens */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #000000;
            }
        }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splash">
        <div class="splash-logo">MEGA<span>FOREX</span></div>
        <div class="splash-subtitle">Institutional Grade Trading</div>
        <div class="splash-loader"></div>
    </div>

    <!-- Pull to Refresh Indicator -->
    <div class="pull-indicator" id="pull-indicator">↻ Release to refresh</div>

    <!-- Header -->
    <header class="header">
        <div class="logo">MEGA<span>FOREX</span> v9.2.2 <span style="color: var(--accent-green); font-size: 0.7em;">PRO</span></div>
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="total-pairs">45</div>
                <div class="stat-label">Pairs</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-signals">-</div>
                <div class="stat-label">Signals</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="bullish-count" style="color: var(--accent-green);">-</div>
                <div class="stat-label">Bullish</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="bearish-count" style="color: var(--accent-red);">-</div>
                <div class="stat-label">Bearish</div>
            </div>
        </div>
        <div class="connection-status">
            <div class="status-dot" id="connection-dot"></div>
            <span id="connection-text">Connected</span>
        </div>
        <div class="refresh-timer">
            <span>Refresh in:</span>
            <span id="refresh-countdown">120s</span>
        </div>
    </header>
    
    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="overview">📊 Overview</button>
            <button class="nav-tab" data-tab="rates">💹 Live Rates</button>
            <button class="nav-tab" data-tab="analyzer">🔬 Pair Analyzer</button>
            <button class="nav-tab" data-tab="technical">📉 Technical</button>
            <button class="nav-tab" data-tab="positioning">👥 Positioning</button>
            <button class="nav-tab" data-tab="news">📰 News</button>
            <button class="nav-tab" data-tab="calendar">📅 Calendar</button>
            <button class="nav-tab" data-tab="weights">⚖️ Weights</button>
            <button class="nav-tab" data-tab="audit">🔍 Audit</button>
            <button class="nav-tab" data-tab="api-status">⚙️ API Status</button>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Overview Tab -->
        <div class="tab-content active" id="tab-overview">
            <div class="filters-bar">
                <div class="filter-group">
                    <span class="filter-label">Category:</span>
                    <select id="filter-category">
                        <option value="all">All</option>
                        <option value="major">Major</option>
                        <option value="cross">Cross</option>
                        <option value="exotic">Exotic</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Direction:</span>
                    <select id="filter-direction">
                        <option value="all">All</option>
                        <option value="long">Long Only</option>
                        <option value="short">Short Only</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Grade:</span>
                    <select id="filter-grade">
                        <option value="all">All Grades</option>
                        <option value="grade-a">Grade A (A+ & A)</option>
                        <option value="grade-b">Grade B</option>
                        <option value="grade-c">Grade C</option>
                    </select>
                </div>
                <button onclick="loadSignals()">🔄 Refresh</button>
                <button onclick="showAIInsights()" style="background: linear-gradient(135deg, #8b5cf6, #3b82f6); margin-left: 0.5rem;">🤖 AI Insights</button>
                <button onclick="showCorrelation()" style="background: linear-gradient(135deg, #10b981, #059669); margin-left: 0.5rem;">📊 Correlation</button>
            </div>
            <div class="signals-grid" id="signals-container">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading signals...
                </div>
            </div>
        </div>
        
        <!-- Live Rates Tab -->
        <div class="tab-content" id="tab-rates">
            <h2 style="margin-bottom: 1rem;">💹 Live Forex Rates</h2>
            <div class="filters-bar">
                <div class="filter-group">
                    <span class="filter-label">Category:</span>
                    <select id="rates-category">
                        <option value="all">All (45)</option>
                        <option value="major">Major (7)</option>
                        <option value="cross">Cross (23)</option>
                        <option value="exotic">Exotic (15)</option>
                    </select>
                </div>
            </div>
            <table class="data-table" id="rates-table">
                <thead>
                    <tr>
                        <th>Pair</th>
                        <th>Bid</th>
                        <th>Ask</th>
                        <th>Spread</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody id="rates-body">
                    <tr><td colspan="5" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pair Analyzer Tab -->
        <div class="tab-content" id="tab-analyzer">
            <h2 style="margin-bottom: 1rem;">🔬 Pair Analyzer</h2>
            <div class="analyzer-container">
                <div class="pair-list" id="analyzer-pairs">
                    <!-- Pairs will be loaded here -->
                </div>
                <div class="analyzer-detail" id="analyzer-detail">
                    <p style="color: var(--text-secondary);">Select a pair to analyze</p>
                </div>
            </div>
        </div>
        
        <!-- Trade Journal Tab -->
        
        <!-- Technical Tab -->
        <div class="tab-content" id="tab-technical">
            <h2 style="margin-bottom: 1rem;">📉 Technical Indicators</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Pair</th>
                        <th>RSI</th>
                        <th>MACD</th>
                        <th>ADX</th>
                        <th>ATR</th>
                        <th>BB %</th>
                        <th>EMA Signal</th>
                    </tr>
                </thead>
                <tbody id="technical-body">
                    <tr><td colspan="7" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Positioning Tab -->
        <div class="tab-content" id="tab-positioning">
            <h2 style="margin-bottom: 1rem;">👥 Retail Positioning</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Contrarian indicator: When retail is heavily long, consider selling. When heavily short, consider buying.
            </p>
            <div id="positioning-container">
                <div class="loading"><div class="spinner"></div>Loading...</div>
            </div>
        </div>
        
        <!-- News Tab -->
        <div class="tab-content" id="tab-news">
            <h2 style="margin-bottom: 1rem;">📰 Forex News & Sentiment</h2>
            <div id="news-container">
                <div class="loading"><div class="spinner"></div>Loading...</div>
            </div>
        </div>
        
        <!-- Calendar Tab -->
        <div class="tab-content" id="tab-calendar">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2>📅 Economic Calendar</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="filter-group">
                        <span class="filter-label">Currency:</span>
                        <select id="calendar-currency">
                            <option value="all">All Currencies</option>
                            <option value="USD">🇺🇸 USD</option>
                            <option value="EUR">🇪🇺 EUR</option>
                            <option value="GBP">🇬🇧 GBP</option>
                            <option value="JPY">🇯🇵 JPY</option>
                            <option value="AUD">🇦🇺 AUD</option>
                            <option value="CAD">🇨🇦 CAD</option>
                            <option value="NZD">🇳🇿 NZD</option>
                            <option value="CHF">🇨🇭 CHF</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Impact:</span>
                        <select id="calendar-impact">
                            <option value="all">All</option>
                            <option value="high">🔴 High Only</option>
                            <option value="medium">🟡 Medium+</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Calendar Legend -->
            <div style="display: flex; gap: 2rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444;"></span>
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">High Impact</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="width: 12px; height: 12px; border-radius: 50%; background: #f59e0b;"></span>
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">Medium Impact</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="width: 12px; height: 12px; border-radius: 50%; background: #10b981;"></span>
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">Low Impact</span>
                </div>
            </div>
            
            <!-- Calendar Table -->
            <div id="calendar-container">
                <div class="loading"><div class="spinner"></div>Loading economic events...</div>
            </div>
        </div>
        
        <!-- Weights Editor Tab -->
        <div class="tab-content" id="tab-weights">
            <h2 style="margin-bottom: 1rem;">⚖️ Factor Group Weights Editor (v9.2.2)</h2>
            <div class="weights-editor" id="weights-editor">
                <div class="loading"><div class="spinner"></div>Loading weights...</div>
            </div>
        </div>
        
        <!-- Audit Tab -->
        <div class="tab-content" id="tab-audit">
            <h2 style="margin-bottom: 1rem;">🔍 System Audit & Scoring Methodology</h2>
            <button onclick="runAudit()" style="margin-bottom: 1rem; margin-right: 0.5rem;">▶ Run Full Audit</button>
            <button onclick="showMethodology()" style="margin-bottom: 1rem; margin-right: 0.5rem;">📖 View Scoring Methodology</button>
            <button onclick="runSignalEvaluation()" style="margin-bottom: 1rem; background: linear-gradient(135deg, #3b82f6, #8b5cf6);">📊 Signal Accuracy (90 Days)</button>
            <div id="audit-container">
                <p style="color: var(--text-secondary);">Click Run Audit to check system health or View Methodology to see scoring details</p>
            </div>
        </div>
        
        <!-- API Status Tab -->
        <div class="tab-content" id="tab-api-status">
            <h2 style="margin-bottom: 1rem;">⚙️ API Connection Status</h2>
            <div id="api-status-container">
                <div class="loading"><div class="spinner"></div>Loading...</div>
            </div>
        </div>
    </main>

    <script>
        // Configuration
        // Dynamic API_BASE - works on localhost and Railway
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000'
            : window.location.origin;
        let signalsData = [];
        let refreshInterval;
        let countdown = 120;  // 2 minutes auto-refresh
        
        // All 45 Forex Pairs for Pair Analyzer
        const ALL_PAIRS = [
            // Majors (7)
            'EUR/USD', 'GBP/USD', 'USD/JPY', 'USD/CHF', 'AUD/USD', 'USD/CAD', 'NZD/USD',
            // Crosses (21)
            'EUR/GBP', 'EUR/JPY', 'EUR/CHF', 'EUR/AUD', 'EUR/CAD', 'EUR/NZD',
            'GBP/JPY', 'GBP/CHF', 'GBP/AUD', 'GBP/CAD', 'GBP/NZD',
            'AUD/JPY', 'AUD/NZD', 'AUD/CAD', 'AUD/CHF',
            'NZD/JPY', 'NZD/CAD', 'NZD/CHF',
            'CAD/JPY', 'CAD/CHF', 'CHF/JPY',
            // Exotics (17)
            'USD/SGD', 'USD/HKD', 'USD/MXN', 'USD/ZAR', 'USD/TRY', 
            'USD/NOK', 'USD/SEK', 'USD/DKK', 'USD/PLN',
            'EUR/TRY', 'EUR/PLN', 'EUR/NOK', 'EUR/SEK', 'EUR/HUF', 'EUR/CZK',
            'SGD/JPY', 'HKD/JPY'
        ];
        
        // Tab Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                
                // Load data for specific tabs
                const tabName = tab.dataset.tab;
                if (tabName === 'rates') loadRates();
                else if (tabName === 'analyzer') loadAnalyzerPairs();
                else if (tabName === 'technical') loadTechnical();
                else if (tabName === 'positioning') loadPositioning();
                else if (tabName === 'news') loadNews();
                else if (tabName === 'calendar') loadCalendar(true); // Force refresh to clear old cache
                else if (tabName === 'weights') loadWeights();
                else if (tabName === 'api-status') loadApiStatus();
            });
        });
        
        // Load Signals - Uses /signals endpoint
        let lastSignalsUpdate = null;
        async function loadSignals(forceRefresh = false) {
            const container = document.getElementById('signals-container');
            const loadingText = forceRefresh ? 'Auto-refreshing signals...' : 'Loading signals...';
            container.innerHTML = `<div class="loading"><div class="spinner"></div>${loadingText}</div>`;

            try {
                // v9.2.2: Add refresh=true on auto-refresh to clear server cache
                const refreshParam = forceRefresh ? '&refresh=true' : '';
                const response = await fetch(`${API_BASE}/signals?t=${Date.now()}${refreshParam}`);
                const data = await response.json();

                if (data.success && data.signals) {
                    signalsData = data.signals;
                    lastSignalsUpdate = new Date();
                    renderSignals();
                    updateStats();
                    document.getElementById('connection-dot').style.background = 'var(--accent-green)';
                    document.getElementById('connection-text').textContent = 'Connected';
                    // Update refresh timer display
                    updateRefreshTimer();
                } else {
                    throw new Error('No signals data');
                }
            } catch (error) {
                console.error('Error loading signals:', error);
                container.innerHTML = '<div class="loading" style="color: var(--accent-red);">Failed to load signals. Is backend running?</div>';
                document.getElementById('connection-dot').style.background = 'var(--accent-red)';
                document.getElementById('connection-text').textContent = 'Disconnected';
            }
        }
        
        // Render Signals
        function renderSignals() {
            const container = document.getElementById('signals-container');
            const category = document.getElementById('filter-category').value;
            const direction = document.getElementById('filter-direction').value;
            const grade = document.getElementById('filter-grade').value;

            let filtered = signalsData.filter(s => {
                if (category !== 'all' && s.category.toLowerCase() !== category) return false;
                if (direction !== 'all' && s.direction.toLowerCase() !== direction) return false;
                // Filter by TRADE QUALITY GRADE
                if (grade !== 'all') {
                    const tradeQuality = s.trade_setup?.trade_quality || 'C';
                    if (grade === 'grade-a' && !['A+', 'A'].includes(tradeQuality)) return false;
                    if (grade === 'grade-b' && tradeQuality !== 'B') return false;
                    if (grade === 'grade-c' && tradeQuality !== 'C') return false;
                }
                return true;
            });
            
            // Sort: LONG/SHORT first (best trades), NEUTRAL last
            // Within each group, sort by win rate (highest first)
            filtered.sort((a, b) => {
                const dirA = a.direction || 'NEUTRAL';
                const dirB = b.direction || 'NEUTRAL';
                // Priority: LONG/SHORT = 0, NEUTRAL = 1
                const priorityA = (dirA === 'LONG' || dirA === 'SHORT') ? 0 : 1;
                const priorityB = (dirB === 'LONG' || dirB === 'SHORT') ? 0 : 1;
                // First sort by priority (actionable first)
                if (priorityA !== priorityB) return priorityA - priorityB;
                // Then by win rate (highest first)
                return (b.statistics?.win_rate || 50) - (a.statistics?.win_rate || 50);
            });
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">No signals match your filters</div>';
                return;
            }
            
            container.innerHTML = filtered.map(s => createSignalCard(s)).join('');
        }
        
        // Create Signal Card
        function createSignalCard(signal) {
            const winRate = (signal.statistics?.win_rate || 50);
            const scoreClass = winRate >= 60 ? 'bullish' : winRate <= 45 ? 'bearish' : 'neutral';
            const dirClass = signal.direction.toLowerCase();
            const cardClass = signal.direction === 'LONG' ? 'bullish-card' : signal.direction === 'SHORT' ? 'bearish-card' : 'neutral-card';
            const stars = '★'.repeat(signal.stars) + '☆'.repeat(5 - signal.stars);
            
            // Data quality indicator
            const dataQuality = signal.data_quality || signal.rate?.source || 'ESTIMATED';
            const isRealData = ['POLYGON', 'HIGH', 'MEDIUM', 'REAL'].includes(dataQuality);
            const qualityBadge = isRealData 
                ? '<span style="background: rgba(0,255,136,0.2); color: #00ff88; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; margin-left: 4px;">✓ LIVE</span>'
                : '<span style="background: rgba(255,170,0,0.2); color: #ffaa00; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; margin-left: 4px;">~ EST</span>';
            
            const factorGrid = Object.entries(signal.factor_grid || {}).map(([key, value]) => 
                `<div class="factor-item ${value}">${key}</div>`
            ).join('');
            
            const stats = signal.statistics || {};
            
            return `
                <div class="signal-card ${cardClass}" onclick="analyzeSignal('${signal.pair}')">
                    <div class="card-header">
                        <div class="pair-info">
                            <span class="pair-name">${signal.pair}</span>
                            <span class="category-badge ${signal.category.toLowerCase()}">${signal.category}</span>
                            ${qualityBadge}
                        </div>
                        <div class="composite-score">
                            <div class="score-value ${scoreClass}">${winRate.toFixed(1)}%</div>
                            <div class="stars">${stars}</div>
                        </div>
                    </div>

                    <div class="percentage-scores" style="display: flex; justify-content: space-between; margin: 0.5rem 0; padding: 0.3rem; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.75rem;">
                        <span style="color: var(--accent-green);">LONG: ${(signal.long_score || 0).toFixed(1)}%</span>
                        <span style="color: var(--accent-red);">SHORT: ${(signal.short_score || 0).toFixed(1)}%</span>
                    </div>

                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span class="direction-badge ${dirClass}">${signal.direction}${signal.strength_label === 'FILTERED' ? ' (FILTERED)' : ''}</span>
                        ${signal.regime ? `<span class="regime-badge ${signal.regime}">${signal.regime}</span>` : ''}
                    </div>

                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="value">${signal.composite_score}</div>
                            <div class="label">SCORE</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${signal.conviction_v9?.score?.toFixed(0) || '—'}</div>
                            <div class="label">CONV</div>
                        </div>
                        <div class="stat-box" style="background: ${signal.confidence?.confidence_score >= 70 ? 'rgba(0,255,136,0.2)' : signal.confidence?.confidence_score >= 50 ? 'rgba(255,170,0,0.2)' : 'rgba(255,102,102,0.2)'}; border: 1px solid ${signal.confidence?.confidence_score >= 70 ? '#00ff88' : signal.confidence?.confidence_score >= 50 ? '#ffaa00' : '#ff6666'};">
                            <div class="value" style="color: ${signal.confidence?.confidence_score >= 70 ? '#00ff88' : signal.confidence?.confidence_score >= 50 ? '#ffaa00' : '#ff6666'};">${signal.confidence?.confidence_score || '—'}%</div>
                            <div class="label">CONF</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${stats.hold_days || 3}D</div>
                            <div class="label">HOLD</div>
                        </div>
                    </div>

                    ${signal.gates ? `
                    <div class="gates-row">
                        ${Object.entries(signal.gates.details || {}).map(([key, g]) =>
                            `<span class="gate-badge ${g.passed ? 'pass' : 'fail'}">${key.split('_')[0]} ${g.passed ? '✓' : '✗'}</span>`
                        ).join('')}
                    </div>
                    ` : ''}

                    <div class="factor-grid">${factorGrid}</div>
                    
                    <div class="trade-setup">
                        <div class="setup-title">TRADE SETUP ${signal.trade_setup?.trade_quality ? `<span style="color: ${signal.trade_setup.trade_quality === 'A+' ? '#00ff88' : signal.trade_setup.trade_quality === 'A' ? '#00cc66' : signal.trade_setup.trade_quality === 'B' ? '#ffaa00' : '#ff6666'}; margin-left: 0.5rem;">[${signal.trade_setup.trade_quality}]</span>` : ''}</div>
                        <div class="setup-grid" style="grid-template-columns: repeat(5, 1fr);">
                            <div class="setup-item entry">
                                <div class="label">ENTRY</div>
                                <div class="value">${signal.trade_setup?.entry?.toFixed(5) || 'N/A'}</div>
                            </div>
                            <div class="setup-item sl">
                                <div class="label">SL (${signal.trade_setup?.sl_pips?.toFixed(0) || 0}p)</div>
                                <div class="value">${signal.trade_setup?.sl?.toFixed(5) || 'N/A'}</div>
                            </div>
                            <div class="setup-item tp">
                                <div class="label">TP1 (${signal.trade_setup?.tp1_pips?.toFixed(0) || 0}p)</div>
                                <div class="value">${signal.trade_setup?.tp1?.toFixed(5) || 'N/A'}</div>
                            </div>
                            <div class="setup-item tp">
                                <div class="label">R:R</div>
                                <div class="value">1:${signal.trade_setup?.risk_reward_1?.toFixed(1) || signal.trade_setup?.risk_reward?.toFixed(1) || '1.5'}</div>
                            </div>
                            <div class="setup-item" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(59, 130, 246, 0.3)); border: 1px solid rgba(139, 92, 246, 0.5);">
                                <div class="label">⏱️ HOLD</div>
                                <div class="value" style="color: #a78bfa;">${signal.holding_period?.range_text || signal.statistics?.hold_days + 'D' || '3-5D'}</div>
                            </div>
                        </div>
                        ${signal.holding_period ? `
                        <div style="margin-top: 0.5rem; padding: 0.4rem 0.6rem; background: rgba(139, 92, 246, 0.15); border-radius: 0.3rem; border: 1px solid rgba(139, 92, 246, 0.3);">
                            <div style="font-size: 0.7rem; color: #a78bfa; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span>📅 ${signal.holding_period.timeframe}</span>
                                <span>|</span>
                                <span>Entry Window: ${signal.holding_period.entry_window}</span>
                            </div>
                        </div>
                        ` : ''}
                        ${signal.trade_setup?.market_context ? `
                        <div style="margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-muted); display: flex; gap: 0.5rem; justify-content: center;">
                            <span>Vol: ${signal.trade_setup.market_context.volatility}</span>
                            <span>|</span>
                            <span>Trend: ${signal.trade_setup.market_context.trend}</span>
                            <span>|</span>
                            <span>Conf: ${signal.trade_setup.market_context.confidence}</span>
                        </div>
                        ` : ''}
                        ${signal.patterns && signal.patterns.patterns && signal.patterns.patterns.length > 0 ? `
                        <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);">
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.3rem;">🕯️ PATTERNS DETECTED</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; justify-content: center;">
                                ${signal.patterns.patterns.slice(0, 3).map(p => `
                                    <span style="font-size: 0.65rem; padding: 0.2rem 0.4rem; border-radius: 0.2rem; background: ${p.signal === 'BULLISH' ? 'rgba(0,255,136,0.2)' : p.signal === 'BEARISH' ? 'rgba(255,102,102,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${p.signal === 'BULLISH' ? '#00ff88' : p.signal === 'BEARISH' ? '#ff6666' : '#999'};">${p.name.replace('_', ' ')}</span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // Update Stats
        function updateStats() {
            document.getElementById('total-signals').textContent = signalsData.length;
            document.getElementById('bullish-count').textContent = signalsData.filter(s => s.direction === 'LONG').length;
            document.getElementById('bearish-count').textContent = signalsData.filter(s => s.direction === 'SHORT').length;
        }
        
        // Load Rates
        async function loadRates() {
            try {
                const response = await fetch(`${API_BASE}/rates`);
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('rates-body');
                    const category = document.getElementById('rates-category').value;
                    
                    let rates = Object.entries(data.rates);
                    
                    tbody.innerHTML = rates.map(([pair, rate]) => `
                        <tr>
                            <td style="font-weight: 600;">${pair}</td>
                            <td>${rate.bid?.toFixed(5) || 'N/A'}</td>
                            <td>${rate.ask?.toFixed(5) || 'N/A'}</td>
                            <td>${((rate.ask - rate.bid) * 10000).toFixed(1)} pips</td>
                            <td><span class="status-badge ${rate.source === 'polygon' ? 'ok' : rate.source === 'exchangerate' ? 'limited' : 'error'}">${rate.source}</span></td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading rates:', error);
            }
        }
        
        // Load Analyzer Pairs
        function loadAnalyzerPairs() {
            const container = document.getElementById('analyzer-pairs');
            
            // Show ALL 45 pairs, with score from signalsData if available
            container.innerHTML = ALL_PAIRS.map(pair => {
                const signal = signalsData.find(s => s.pair === pair);
                const score = signal ? signal.composite_score : '--';
                const direction = signal ? signal.direction : 'NEUTRAL';
                const color = direction === 'LONG' ? 'var(--accent-green)' : direction === 'SHORT' ? 'var(--accent-red)' : 'var(--text-secondary)';
                
                return `
                    <div class="pair-list-item" onclick="analyzeSignal('${pair}')">
                        <span>${pair}</span>
                        <span style="color: ${color}">${score}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Analyze Signal
        async function analyzeSignal(pair, forceFresh = false) {
            const detail = document.getElementById('analyzer-detail');

            // Switch to analyzer tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="analyzer"]').classList.add('active');
            document.getElementById('tab-analyzer').classList.add('active');

            // v9.2.2: Use LOCAL signalsData first (guarantees consistency with cards)
            // Only fetch from server if forceFresh or pair not in local data
            let signal = null;

            if (!forceFresh && signalsData && signalsData.length > 0) {
                // Find the signal in our already-loaded data
                const cachedSignal = signalsData.find(s => s.pair === pair);
                if (cachedSignal) {
                    signal = { success: true, from_local: true, ...cachedSignal };
                    console.log(`📋 Using local data for ${pair} (matches card exactly)`);
                }
            }

            if (!signal) {
                // Need to fetch from server
                const loadingText = forceFresh ? 'Fetching FRESH data from market...' : 'Loading analysis...';
                detail.innerHTML = `<div class="loading"><div class="spinner"></div>${loadingText}</div>`;

                try {
                    const freshParam = forceFresh ? '&fresh=true' : '';
                    const response = await fetch(`${API_BASE}/signal/${pair.replace('/', '_')}?t=${Date.now()}${freshParam}`);
                    signal = await response.json();
                } catch (err) {
                    detail.innerHTML = `<div class="error">Failed to load analysis: ${err.message}</div>`;
                    return;
                }
            }

            try {
                
                if (signal.success) {
                    // Build AI Cross-Validation HTML before template literal
                    let aiValidationHtml = '';
                    const aiDet = signal.factors?.ai?.details || {};
                    const aiVal = aiDet.validation || {};
                    const aiFlags = aiVal.flags || [];
                    const aiConsistent = aiVal.consistent !== false;
                    const aiAnalysisText = aiDet.analysis || '';
                    const aiConf = aiDet.confidence || 'N/A';
                    const aiRecDir = aiVal.recommended_direction || 'N/A';

                    if (aiAnalysisText || aiFlags.length > 0) {
                        const borderColor = aiConsistent ? 'rgba(52, 211, 153, 0.4)' : 'rgba(239, 68, 68, 0.5)';
                        const statusBg = aiConsistent ? 'rgba(52, 211, 153, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                        const statusColor = aiConsistent ? '#34d399' : '#ef4444';
                        const statusText = aiConsistent ? 'CONSISTENT' : 'FLAGS FOUND';
                        const dirColor = aiRecDir === 'LONG' ? '#34d399' : aiRecDir === 'SHORT' ? '#ef4444' : '#fbbf24';

                        let flagsHtml = '';
                        if (aiFlags.length > 0) {
                            flagsHtml = '<div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 0.75rem;">' +
                                '<div style="font-size: 0.8rem; font-weight: 600; color: #fbbf24; margin-bottom: 0.4rem;">Warning: Validation Flags:</div>' +
                                aiFlags.map(f => '<div style="font-size: 0.8rem; color: var(--text-secondary); padding: 0.3rem 0 0.3rem 1rem; border-left: 2px solid #ef4444;">' + f + '</div>').join('') +
                                '</div>';
                        }

                        aiValidationHtml = '<div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(59, 130, 246, 0.1)); border: 1px solid ' + borderColor + '; border-radius: 0.75rem;">' +
                            '<h4 style="margin: 0 0 0.75rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">' +
                            '<span>AI Cross-Validation</span>' +
                            '<span style="font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 1rem; background: ' + statusBg + '; color: ' + statusColor + '; font-weight: 600;">' + statusText + '</span>' +
                            '<span style="font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 1rem; background: rgba(255,255,255,0.1); color: var(--text-muted);">Confidence: ' + aiConf + '</span>' +
                            '</h4>' +
                            '<div style="padding: 0.6rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem; margin-bottom: 0.75rem;">' +
                            '<div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;"><strong style="color: #a78bfa;">AI Analysis:</strong> ' + aiAnalysisText + '</div>' +
                            '</div>' +
                            '<div style="display: flex; gap: 1rem; flex-wrap: wrap;">' +
                            '<div style="font-size: 0.8rem; color: var(--text-muted);">AI Recommended Direction: <strong style="color: ' + dirColor + ';">' + aiRecDir + '</strong></div>' +
                            '<div style="font-size: 0.8rem; color: var(--text-muted);">Factors Checked: <strong>' + (aiVal.factors_checked || 0) + '</strong></div>' +
                            '</div>' +
                            flagsHtml +
                            '</div>';
                    }

                    const fetchTime = new Date().toLocaleTimeString();
                    let cacheStatus;
                    if (signal.from_local) {
                        // Data from local signalsData array - 100% matches the card
                        cacheStatus = `<span style="color: var(--accent-green);">✓ Same data as Overview card</span> <button onclick="analyzeSignal('${signal.pair}', true)" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.7rem; background: var(--accent-purple); border: none; border-radius: 4px; color: white; cursor: pointer;">🔄 Get Fresh</button>`;
                    } else if (signal.from_cache) {
                        // Data from server cache
                        cacheStatus = `<span style="color: var(--accent-blue);">📋 Server cached data</span> <button onclick="analyzeSignal('${signal.pair}', true)" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.7rem; background: var(--accent-purple); border: none; border-radius: 4px; color: white; cursor: pointer;">🔄 Get Fresh</button>`;
                    } else {
                        // Fresh data from server
                        cacheStatus = `<span style="color: var(--accent-purple);">🔄 Fresh data at ${fetchTime}</span>`;
                    }
                    detail.innerHTML = `
                        <h3 style="margin-bottom: 0.5rem;">${signal.pair} Analysis</h3>
                        <div style="font-size: 0.75rem; margin-bottom: 1rem;">${cacheStatus}</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="result-card">
                                <div class="value ${signal.composite_score >= 60 ? '' : 'style="color: var(--accent-red)"'}">${signal.composite_score}</div>
                                <div class="label">Composite Score</div>
                            </div>
                            <div class="result-card">
                                <div class="value" style="color: ${signal.direction === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)'}">${signal.direction}</div>
                                <div class="label">Direction</div>
                            </div>
                        </div>
                        
                        <h4 style="margin-bottom: 0.5rem;">v9.2.2 Factor Groups (8 Groups)</h4>
                        <table class="data-table" style="margin-bottom: 1rem;">
                            <thead>
                                <tr><th>Group</th><th>Weight</th><th>Score</th><th>Signal</th></tr>
                            </thead>
                            <tbody>
                                ${Object.entries(signal.factor_groups || {}).map(([name, g]) => `
                                    <tr>
                                        <td style="text-transform: capitalize;">${name.replace(/_/g, ' ')}</td>
                                        <td>${g.weight || '-'}%</td>
                                        <td style="color: ${g.score >= 58 ? 'var(--accent-green)' : g.score <= 42 ? 'var(--accent-red)' : 'var(--text-primary)'}; font-weight: 600;">${g.score}</td>
                                        <td><span class="status-badge ${g.signal === 'BULLISH' ? 'ok' : g.signal === 'BEARISH' ? 'error' : 'limited'}">${g.signal}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <details style="margin-bottom: 1rem;">
                            <summary style="cursor: pointer; color: var(--text-muted); font-size: 0.85rem;">Show 11 Individual Factors</summary>
                            <table class="data-table" style="margin-top: 0.5rem;">
                                <thead>
                                    <tr><th>Factor</th><th>Score</th><th>Signal</th></tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(signal.factors || {}).map(([name, data]) => `
                                        <tr>
                                            <td style="text-transform: capitalize;">${name}</td>
                                            <td>${data.score?.toFixed(1) || 'N/A'}</td>
                                            <td><span class="status-badge ${data.signal === 'BULLISH' ? 'ok' : data.signal === 'BEARISH' ? 'error' : 'limited'}">${data.signal}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </details>

                        ${aiValidationHtml}

                        <h4 style="margin-bottom: 0.5rem;">Technical Indicators</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                            <div class="result-card">
                                <div class="value">${signal.technical?.rsi?.toFixed(1) || 'N/A'}</div>
                                <div class="label">RSI</div>
                            </div>
                            <div class="result-card">
                                <div class="value">${signal.technical?.adx?.toFixed(1) || 'N/A'}</div>
                                <div class="label">ADX</div>
                            </div>
                            <div class="result-card">
                                <div class="value">${signal.technical?.atr?.toFixed(5) || 'N/A'}</div>
                                <div class="label">ATR</div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 1rem 0 0.5rem;">Smart Trade Setup ${signal.trade_setup?.trade_quality ? `<span style="color: ${signal.trade_setup.trade_quality === 'A+' ? '#00ff88' : signal.trade_setup.trade_quality === 'A' ? '#00cc66' : signal.trade_setup.trade_quality === 'B' ? '#ffaa00' : '#ff6666'}; font-size: 0.9rem;">[Grade: ${signal.trade_setup.trade_quality}]</span>` : ''}</h4>
                        
                        ${signal.trade_setup?.market_context ? `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem; display: flex; gap: 1.5rem; justify-content: center; flex-wrap: wrap;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">VOLATILITY</div>
                                <div style="font-weight: 600; color: ${signal.trade_setup.market_context.volatility === 'HIGH' ? '#ff6666' : signal.trade_setup.market_context.volatility === 'LOW' ? '#66aaff' : '#00cc66'};">${signal.trade_setup.market_context.volatility}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">TREND</div>
                                <div style="font-weight: 600; color: ${signal.trade_setup.market_context.trend === 'STRONG' ? '#00ff88' : signal.trade_setup.market_context.trend === 'WEAK' ? '#ffaa00' : '#00cc66'};">${signal.trade_setup.market_context.trend}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">CONFIDENCE</div>
                                <div style="font-weight: 600; color: ${signal.trade_setup.market_context.confidence === 'HIGH' ? '#00ff88' : signal.trade_setup.market_context.confidence === 'LOW' ? '#ff6666' : '#ffaa00'};">${signal.trade_setup.market_context.confidence}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">SL MULT</div>
                                <div style="font-weight: 600;">${signal.trade_setup.sl_multiplier || '1.8'}x</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">TP MULT</div>
                                <div style="font-weight: 600;">${signal.trade_setup.tp1_multiplier || '2.5'}x</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="trade-setup">
                            <div class="setup-grid" style="grid-template-columns: repeat(5, 1fr);">
                                <div class="setup-item entry">
                                    <div class="label">ENTRY</div>
                                    <div class="value">${signal.trade_setup?.entry?.toFixed(5) || 'N/A'}</div>
                                </div>
                                <div class="setup-item sl">
                                    <div class="label">SL (${signal.trade_setup?.sl_pips?.toFixed(0) || 0}p)</div>
                                    <div class="value">${signal.trade_setup?.sl?.toFixed(5) || 'N/A'}</div>
                                </div>
                                <div class="setup-item tp">
                                    <div class="label">TP1 (${signal.trade_setup?.tp1_pips?.toFixed(0) || 0}p)</div>
                                    <div class="value">${signal.trade_setup?.tp1?.toFixed(5) || 'N/A'}</div>
                                </div>
                                <div class="setup-item tp">
                                    <div class="label">TP2 (${signal.trade_setup?.tp2_pips?.toFixed(0) || 0}p)</div>
                                    <div class="value">${signal.trade_setup?.tp2?.toFixed(5) || 'N/A'}</div>
                                </div>
                                <div class="setup-item" style="background: var(--bg-secondary);">
                                    <div class="label">R:R</div>
                                    <div class="value" style="color: ${(signal.trade_setup?.risk_reward_1 || 1.5) >= 2 ? '#00ff88' : (signal.trade_setup?.risk_reward_1 || 1.5) >= 1.5 ? '#00cc66' : '#ffaa00'};">1:${signal.trade_setup?.risk_reward_1?.toFixed(1) || '1.5'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Holding Period Section -->
                        <h4 style="margin: 1.5rem 0 0.5rem;">⏱️ Recommended Holding Period</h4>
                        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.2)); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                <div style="text-align: center; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #a78bfa;">${signal.holding_period?.recommended_days || signal.statistics?.hold_days || 3}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">RECOMMENDED DAYS</div>
                                </div>
                                <div style="text-align: center; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #60a5fa;">${signal.holding_period?.range_text || '2-5 days'}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">HOLDING RANGE</div>
                                </div>
                                <div style="text-align: center; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                                    <div style="font-size: 1rem; font-weight: 700; color: #34d399;">${signal.holding_period?.timeframe || 'SWING'}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">TRADE TYPE</div>
                                </div>
                                <div style="text-align: center; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 0.5rem;">
                                    <div style="font-size: 1rem; font-weight: 700; color: #fbbf24;">${signal.holding_period?.entry_window || '1-2 days'}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted);">ENTRY WINDOW</div>
                                </div>
                            </div>
                            
                            ${signal.holding_period?.factors_considered ? `
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; padding-top: 0.75rem; border-top: 1px solid rgba(139, 92, 246, 0.3);">
                                <span style="font-size: 0.75rem; padding: 0.3rem 0.6rem; background: rgba(0,0,0,0.3); border-radius: 1rem; color: var(--text-secondary);">
                                    📊 Category: <strong style="color: #a78bfa;">${signal.holding_period.factors_considered.category}</strong>
                                </span>
                                <span style="font-size: 0.75rem; padding: 0.3rem 0.6rem; background: rgba(0,0,0,0.3); border-radius: 1rem; color: var(--text-secondary);">
                                    📈 Volatility: <strong style="color: ${signal.holding_period.factors_considered.volatility === 'HIGH' ? '#ef4444' : signal.holding_period.factors_considered.volatility === 'LOW' ? '#60a5fa' : '#34d399'};">${signal.holding_period.factors_considered.volatility}</strong>
                                </span>
                                <span style="font-size: 0.75rem; padding: 0.3rem 0.6rem; background: rgba(0,0,0,0.3); border-radius: 1rem; color: var(--text-secondary);">
                                    💪 Trend: <strong style="color: ${signal.holding_period.factors_considered.trend_strength === 'STRONG' ? '#34d399' : signal.holding_period.factors_considered.trend_strength === 'WEAK' ? '#fbbf24' : '#60a5fa'};">${signal.holding_period.factors_considered.trend_strength}</strong>
                                </span>
                                <span style="font-size: 0.75rem; padding: 0.3rem 0.6rem; background: rgba(0,0,0,0.3); border-radius: 1rem; color: var(--text-secondary);">
                                    🎯 Signal: <strong style="color: #a78bfa;">${signal.holding_period.factors_considered.signal_strength}</strong>
                                </span>
                                <span style="font-size: 0.75rem; padding: 0.3rem 0.6rem; background: rgba(0,0,0,0.3); border-radius: 1rem; color: var(--text-secondary);">
                                    📅 MTF Aligned: <strong style="color: ${signal.holding_period.factors_considered.mtf_aligned ? '#34d399' : '#ef4444'};">${signal.holding_period.factors_considered.mtf_aligned ? 'YES' : 'NO'}</strong>
                                </span>
                            </div>
                            ` : ''}
                            
                            <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(0,0,0,0.3); border-radius: 0.5rem; text-align: center;">
                                <div style="font-size: 0.85rem; color: #a78bfa; font-weight: 600;">
                                    💡 ${signal.holding_period?.recommendation || 'Hold for ' + (signal.statistics?.hold_days || 3) + ' days'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- TradingView Chart -->
                        <h4 style="margin: 1.5rem 0 0.5rem;">Price Chart</h4>
                        <div style="height: 400px; background: var(--bg-secondary); border-radius: 0.5rem; overflow: hidden;">
                            <iframe 
                                src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview&symbol=${signal.pair.replace('/', '')}&interval=60&theme=dark&style=1&locale=en&toolbar_bg=%231a1f2e&enable_publishing=false&hide_top_toolbar=false&hide_legend=false&save_image=false&container_id=tradingview_chart"
                                style="width: 100%; height: 100%; border: none;">
                            </iframe>
                        </div>
                    `;
                }
            } catch (error) {
                detail.innerHTML = '<p style="color: var(--accent-red);">Error loading analysis</p>';
            }
        }
        
        // Load Technical
        async function loadTechnical() {
            try {
                const tbody = document.getElementById('technical-body');
                tbody.innerHTML = signalsData.slice(0, 20).map(s => `
                    <tr>
                        <td style="font-weight: 600;">${s.pair}</td>
                        <td style="color: ${s.technical?.rsi < 30 ? 'var(--accent-green)' : s.technical?.rsi > 70 ? 'var(--accent-red)' : 'inherit'}">${s.technical?.rsi?.toFixed(1) || 'N/A'}</td>
                        <td style="color: ${s.technical?.macd?.histogram > 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${s.technical?.macd?.histogram?.toFixed(5) || 'N/A'}</td>
                        <td>${s.technical?.adx?.toFixed(1) || 'N/A'}</td>
                        <td>${s.technical?.atr?.toFixed(5) || 'N/A'}</td>
                        <td>${s.technical?.bollinger?.percent_b?.toFixed(1) || 'N/A'}%</td>
                        <td><span class="status-badge ${s.technical?.ema_signal === 'BULLISH' ? 'ok' : s.technical?.ema_signal === 'BEARISH' ? 'error' : 'limited'}">${s.technical?.ema_signal || 'N/A'}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading technical:', error);
            }
        }
        
        // Load Positioning
        async function loadPositioning() {
            try {
                const response = await fetch(`${API_BASE}/positioning`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('positioning-container');
                    
                    // Show data source indicator based on source type
                    let sourceLabel, sourceColor;
                    switch(data.source) {
                        case 'IG_MARKETS_REAL':
                            sourceLabel = '📊 REAL DATA from IG Markets';
                            sourceColor = 'var(--accent-green)';
                            break;
                        case 'RATE_LIMITED':
                            sourceLabel = '⏳ IG API Rate Limited - Using Neutral Estimates';
                            sourceColor = 'var(--accent-yellow)';
                            break;
                        case 'FALLBACK':
                            sourceLabel = '⚠️ IG API Temporarily Unavailable - Using Estimates';
                            sourceColor = 'var(--accent-yellow)';
                            break;
                        default:
                            sourceLabel = '⚠️ Configure IG API for real positioning data';
                            sourceColor = 'var(--accent-red)';
                    }

                    let html = `<div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem; text-align: center;">
                        <span style="color: ${sourceColor}; font-weight: 600;">${sourceLabel}</span>
                        ${data.message ? `<p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">${data.message}</p>` : ''}
                    </div>`;

                    if (data.source === 'NOT_CONFIGURED') {
                        html += `<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <p>Add IG credentials to .env file for REAL positioning data:</p>
                            <code style="display: block; margin-top: 1rem; padding: 1rem; background: var(--bg-card); border-radius: 0.5rem; text-align: left;">
                            IG_API_KEY=your_api_key<br>
                            IG_USERNAME=your_username<br>
                            IG_PASSWORD=your_password<br>
                            IG_ACC_TYPE=DEMO
                            </code>
                        </div>`;
                    } else {
                        html += data.data.map(p => `
                            <div style="background: var(--bg-card); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">${p.pair}</span>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        ${p.source === 'IG_REAL' ? '<span style="font-size: 0.7rem; color: var(--accent-green);">● IG</span>' : ''}
                                        <span class="status-badge ${p.contrarian_signal === 'LONG' ? 'ok' : p.contrarian_signal === 'SHORT' ? 'error' : 'limited'}">
                                            Contrarian: ${p.contrarian_signal}
                                        </span>
                                    </div>
                                </div>
                                <div class="position-bar">
                                    <div class="position-long" style="width: ${p.long_percentage}%">${p.long_percentage}% Long</div>
                                    <div class="position-short" style="width: ${p.short_percentage}%">${p.short_percentage}% Short</div>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading positioning:', error);
                document.getElementById('positioning-container').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--accent-red);">
                        <p>Failed to load positioning data. Check backend connection.</p>
                    </div>
                `;
            }
        }
        
        // Load News - Headlines are clickable links
        async function loadNews() {
            try {
                const response = await fetch(`${API_BASE}/news`);
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('news-container');

                    if (data.articles && data.articles.length > 0) {
                        container.innerHTML = data.articles.map(article => `
                            <div class="news-item" style="cursor: pointer;" onclick="window.open('${article.url || '#'}', '_blank')">
                                <div class="news-headline" style="color: var(--accent-blue); text-decoration: underline;">
                                    ${article.headline}
                                </div>
                                <div class="news-meta">
                                    ${article.source} | ${new Date(article.datetime * 1000).toLocaleString()}
                                </div>
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">
                                    Tap to read full article →
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p style="color: var(--text-secondary);">No news available. Make sure Finnhub API key is configured.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading news:', error);
            }
        }
        
        // Load Calendar
        async function loadCalendar(forceRefresh = false) {
            try {
                // ALWAYS add timestamp to bypass browser cache
                const timestamp = new Date().getTime();
                const url = forceRefresh
                    ? `${API_BASE}/calendar?refresh=true&t=${timestamp}`
                    : `${API_BASE}/calendar?t=${timestamp}`;
                const response = await fetch(url, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('calendar-container');
                    const impactFilter = document.getElementById('calendar-impact').value;
                    const currencyFilter = document.getElementById('calendar-currency').value;
                    
                    let events = data.events || [];
                    
                    // Filter by impact
                    if (impactFilter !== 'all') {
                        events = events.filter(e => {
                            if (impactFilter === 'high') return e.impact === 'high';
                            return e.impact === 'high' || e.impact === 'medium';
                        });
                    }
                    
                    // Filter by currency
                    if (currencyFilter !== 'all') {
                        const currencyMap = {
                            'USD': ['US', 'USA'],
                            'EUR': ['EU', 'DE', 'FR', 'IT', 'ES'],
                            'GBP': ['UK', 'GB'],
                            'JPY': ['JP'],
                            'AUD': ['AU'],
                            'CAD': ['CA'],
                            'NZD': ['NZ'],
                            'CHF': ['CH']
                        };
                        const codes = currencyMap[currencyFilter] || [currencyFilter];
                        events = events.filter(e => codes.some(c => e.country.toUpperCase().includes(c)));
                    }
                    
                    if (events.length > 0) {
                        const getFlag = (country) => {
                            const flags = {
                                // 2-letter country codes
                                'US': '🇺🇸', 'USA': '🇺🇸',
                                'EU': '🇪🇺', 'DE': '🇩🇪', 'FR': '🇫🇷', 'IT': '🇮🇹', 'ES': '🇪🇸',
                                'UK': '🇬🇧', 'GB': '🇬🇧',
                                'JP': '🇯🇵',
                                'AU': '🇦🇺',
                                'CA': '🇨🇦',
                                'NZ': '🇳🇿',
                                'CH': '🇨🇭',
                                'CN': '🇨🇳',
                                // 3-letter currency codes (from Forex Factory API)
                                'USD': '🇺🇸',
                                'EUR': '🇪🇺',
                                'GBP': '🇬🇧',
                                'JPY': '🇯🇵',
                                'AUD': '🇦🇺',
                                'CAD': '🇨🇦',
                                'NZD': '🇳🇿',
                                'CHF': '🇨🇭',
                                'CNY': '🇨🇳',
                                'ALL': '🌐'
                            };
                            return flags[country.toUpperCase()] || '🌐';
                        };
                        
                        // Data source indicator
                        const dataQuality = data.data_quality || 'UNKNOWN';
                        const dataSource = data.source || 'UNKNOWN';
                        const qualityColor = dataQuality === 'REAL' ? 'var(--accent-green)' : 
                                           dataQuality === 'SCHEDULED' ? '#f59e0b' :  // Amber - real schedule
                                           dataQuality === 'FALLBACK' ? 'var(--accent-red)' : '#f59e0b';
                        const qualityIcon = dataQuality === 'REAL' ? '✓' : 
                                          dataQuality === 'SCHEDULED' ? '📅' : 
                                          dataQuality === 'FALLBACK' ? '⚠' : '~';
                        const qualityLabel = dataQuality === 'SCHEDULED' ? 'LIVE SCHEDULE' : dataQuality;
                        
                        const dataSourceBadge = `
                            <div style="margin-bottom: 1rem; padding: 0.5rem 1rem; background: var(--bg-tertiary); border-radius: 8px; display: inline-flex; align-items: center; gap: 0.5rem;">
                                <span style="color: ${qualityColor}; font-weight: 600;">${qualityIcon} ${qualityLabel}</span>
                                <span style="color: var(--text-muted);">|</span>
                                <span style="color: var(--text-secondary);">Source: ${dataSource}</span>
                                <span style="color: var(--text-muted);">|</span>
                                <span style="color: var(--text-secondary);">${events.length} events</span>
                            </div>
                        `;
                        
                        const getImpactDots = (impact) => {
                            if (impact === 'high') return '<span style="color: #ef4444;">●●●</span>';
                            if (impact === 'medium') return '<span style="color: #f59e0b;">●●</span><span style="color: #374151;">●</span>';
                            return '<span style="color: #10b981;">●</span><span style="color: #374151;">●●</span>';
                        };
                        
                        const getCountdown = (timeStr) => {
                            if (!timeStr) return '<span style="color: var(--text-muted);">--:--</span>';
                            
                            const eventDate = new Date(timeStr);
                            const now = new Date();
                            const diff = eventDate - now;
                            
                            if (diff < 0) return '<span style="color: var(--accent-green);">Released</span>';
                            
                            const hours = Math.floor(diff / (1000 * 60 * 60));
                            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            
                            if (hours > 24) {
                                const days = Math.floor(hours / 24);
                                return `<span style="color: var(--text-secondary);">${days}d ${hours % 24}h</span>`;
                            }
                            if (hours > 0) {
                                return `<span style="color: var(--accent-yellow);">${hours}h ${minutes}m</span>`;
                            }
                            return `<span style="color: var(--accent-red);">${minutes}m</span>`;
                        };
                        
                        const formatTime = (timeStr) => {
                            if (!timeStr) return '--:--';
                            const date = new Date(timeStr);
                            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                        };
                        
                        const formatDate = (timeStr) => {
                            if (!timeStr) return '--';
                            const date = new Date(timeStr);
                            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        };
                        
                        container.innerHTML = `
                            ${dataSourceBadge}
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">Time</th>
                                        <th style="width: 80px;">Currency</th>
                                        <th style="width: 60px;">Impact</th>
                                        <th>Event</th>
                                        <th style="width: 90px;">Forecast</th>
                                        <th style="width: 90px;">Previous</th>
                                        <th style="width: 90px;">Actual</th>
                                        <th style="width: 100px;">Countdown</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${events.map(e => `
                                        <tr style="border-left: 3px solid ${e.impact === 'high' ? '#ef4444' : e.impact === 'medium' ? '#f59e0b' : '#10b981'};">
                                            <td>
                                                <div style="font-weight: 600;">${formatTime(e.time)}</div>
                                                <div style="font-size: 0.7rem; color: var(--text-muted);">${formatDate(e.time)}</div>
                                            </td>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <span style="font-size: 1.25rem;">${getFlag(e.country)}</span>
                                                    <span style="font-weight: 500;">${e.country}</span>
                                                </div>
                                            </td>
                                            <td style="text-align: center;">${getImpactDots(e.impact)}</td>
                                            <td style="font-weight: 500;">${e.event}</td>
                                            <td style="text-align: center; color: var(--text-secondary);">${e.estimate || '-'}</td>
                                            <td style="text-align: center; color: var(--text-secondary);">${e.previous || '-'}</td>
                                            <td style="text-align: center; font-weight: 600; color: ${e.actual ? (parseFloat(e.actual) > parseFloat(e.estimate) ? 'var(--accent-green)' : 'var(--accent-red)') : 'var(--text-muted)'};">
                                                ${e.actual || 'Pending'}
                                            </td>
                                            <td style="text-align: center; font-family: 'JetBrains Mono', monospace;">
                                                ${getCountdown(e.time)}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    } else {
                        // Show data source even when no events match filters
                        const dataQuality = data.data_quality || 'UNKNOWN';
                        const dataSource = data.source || 'UNKNOWN';
                        const totalEvents = data.count || 0;
                        
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">📅</div>
                                ${totalEvents > 0 ? `
                                    <p>No events match your filters.</p>
                                    <p style="font-size: 0.875rem; margin-top: 0.5rem;">Try selecting "All" for Impact and Currency filters.</p>
                                    <p style="font-size: 0.75rem; margin-top: 1rem; color: var(--text-muted);">
                                        Data: ${dataQuality} | Source: ${dataSource} | ${totalEvents} total events loaded
                                    </p>
                                ` : `
                                    <p>No economic events available.</p>
                                    <p style="font-size: 0.875rem; margin-top: 0.5rem; color: ${dataQuality === 'FALLBACK' ? 'var(--accent-red)' : 'var(--text-muted)'};">
                                        Data Source: ${dataSource} (${dataQuality})
                                    </p>
                                    <p style="font-size: 0.75rem; margin-top: 0.5rem;">
                                        ${dataQuality === 'FALLBACK' ? 'Calendar APIs unavailable - showing placeholder data' : 'Check API Status tab for connectivity issues'}
                                    </p>
                                `}
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading calendar:', error);
                document.getElementById('calendar-container').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--accent-red);">
                        <p>Failed to load calendar. Check backend connection.</p>
                    </div>
                `;
            }
        }
        
        // Calendar filter listeners
        document.getElementById('calendar-impact').addEventListener('change', loadCalendar);
        document.getElementById('calendar-currency').addEventListener('change', loadCalendar);
        
        // Load Weights
        async function loadWeights() {
            try {
                const response = await fetch(`${API_BASE}/weights`);
                const data = await response.json();
                
                if (data.success) {
                    const editor = document.getElementById('weights-editor');
                    const weights = data.weights;
                    
                    // v9.0: Format group names nicely
                    const groupLabels = {
                        'trend_momentum': 'Trend & Momentum',
                        'fundamental': 'Fundamental',
                        'sentiment': 'Sentiment',
                        'intermarket': 'Intermarket',
                        'mean_reversion': 'Mean Reversion',
                        'calendar_risk': 'Calendar Risk',
                        'ai_synthesis': 'AI Synthesis'
                    };
                    editor.innerHTML = `
                        ${Object.entries(weights).map(([name, value]) => `
                            <div class="weight-row">
                                <span class="weight-label">${groupLabels[name] || name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                                <input type="range" class="weight-slider" id="weight-${name}" min="0" max="40" value="${value}"
                                    oninput="updateWeightValue('${name}', this.value)">
                                <span class="weight-value" id="value-${name}">${value}%</span>
                            </div>
                        `).join('')}
                        
                        <div class="weights-total" id="weights-total">
                            <span>Total:</span>
                            <span id="total-weight">${Object.values(weights).reduce((a, b) => a + b, 0)}%</span>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button onclick="saveWeights()">💾 Save Weights</button>
                            <button class="secondary" onclick="resetWeights()">🔄 Reset to Defaults</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading weights:', error);
            }
        }
        
        function updateWeightValue(name, value) {
            document.getElementById(`value-${name}`).textContent = `${value}%`;
            
            // Calculate total
            const sliders = document.querySelectorAll('.weight-slider');
            let total = 0;
            sliders.forEach(s => total += parseInt(s.value));
            
            document.getElementById('total-weight').textContent = `${total}%`;
            
            const totalDiv = document.getElementById('weights-total');
            totalDiv.className = 'weights-total ' + (total === 100 ? 'valid' : 'invalid');
        }
        
        async function saveWeights() {
            const weights = {};
            document.querySelectorAll('.weight-slider').forEach(slider => {
                const name = slider.id.replace('weight-', '');
                weights[name] = parseInt(slider.value);
            });
            
            const total = Object.values(weights).reduce((a, b) => a + b, 0);
            if (total !== 100) {
                alert('Weights must sum to 100%');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/weights`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(weights)
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Weights saved successfully!');
                    loadSignals();
                }
            } catch (error) {
                alert('Error saving weights');
            }
        }
        
        async function resetWeights() {
            try {
                const response = await fetch(`${API_BASE}/weights/reset`);
                const data = await response.json();
                if (data.success) {
                    loadWeights();
                    loadSignals();
                }
            } catch (error) {
                alert('Error resetting weights');
            }
        }
        
        // Run Audit
        async function runAudit() {
            const container = document.getElementById('audit-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Running comprehensive audit...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/audit`);
                const data = await response.json();
                
                if (data.success) {
                    container.innerHTML = `
                        <div class="audit-section">
                            <h3>📊 System Info - v${data.version || '8.3'}</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                <div class="result-card">
                                    <div class="value">${data.system_info?.total_pairs || 45}</div>
                                    <div class="label">Forex Pairs</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">${data.system_info?.total_factors || 11}</div>
                                    <div class="label">Scoring Factors</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">${data.data_quality?.coverage || 0}%</div>
                                    <div class="label">Data Coverage</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">${Object.keys(data.api_status || {}).filter(k => ['OK', 'LIMITED', 'SCHEDULED'].includes(data.api_status[k].status)).length}/${Object.keys(data.api_status || {}).filter(k => data.api_status[k].status !== 'NOT_CONFIGURED').length}</div>
                                    <div class="label">APIs Online</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="audit-section">
                            <h3>🔌 API Status</h3>
                            <table class="data-table">
                                <thead>
                                    <tr><th>API</th><th>Status</th><th>Purpose</th><th>Details</th></tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(data.api_status || {}).map(([name, info]) => {
                                        // Map SCHEDULED and FALLBACK to appropriate status classes
                                        let statusClass = info.status === 'OK' ? 'ok' : 
                                                         info.status === 'LIMITED' || info.status === 'SCHEDULED' ? 'limited' : 'error';
                                        let statusLabel = info.status === 'SCHEDULED' ? 'SCHEDULED' : info.status;
                                        return `
                                        <tr>
                                            <td style="text-transform: capitalize; font-weight: 600;">${name.replace('_', ' ')}</td>
                                            <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                                            <td style="font-size: 0.85rem; color: var(--text-secondary);">${info.purpose || '-'}</td>
                                            <td>${info.data_quality || info.test_rate || info.test_value || info.articles || info.events_count || info.sources?.join(', ') || info.error || '-'}</td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="audit-section">
                            <h3>✅ Score Validation (EUR/USD Test)</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                <div class="result-card">
                                    <div class="value" style="color: ${data.score_validation?.composite_score >= 60 ? 'var(--accent-green)' : data.score_validation?.composite_score <= 40 ? 'var(--accent-red)' : 'var(--text-primary)'};">${data.score_validation?.composite_score || 'N/A'}</div>
                                    <div class="label">Composite Score</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">${data.score_validation?.direction || 'N/A'}</div>
                                    <div class="label">Direction</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">${'⭐'.repeat(data.score_validation?.stars || 0)}</div>
                                    <div class="label">Signal Strength</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">${data.score_validation?.strength_label || 'N/A'}</div>
                                    <div class="label">Strength Label</div>
                                </div>
                            </div>
                            <h4 style="margin-top: 1rem;">v9.2.2 Factor Groups (8 Groups):</h4>
                            <table class="data-table">
                                <thead>
                                    <tr><th>Group</th><th>Weight</th><th>Score</th><th>Signal</th></tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(data.score_validation?.factor_groups || {}).map(([name, g]) => `
                                        <tr>
                                            <td style="text-transform: capitalize;">${name.replace(/_/g, ' ')}</td>
                                            <td>${g.weight || '-'}%</td>
                                            <td style="color: ${g.score >= 58 ? 'var(--accent-green)' : g.score <= 42 ? 'var(--accent-red)' : 'var(--text-primary)'}; font-weight: 600;">${g.score}</td>
                                            <td><span class="status-badge ${g.signal === 'BULLISH' ? 'ok' : g.signal === 'BEARISH' ? 'error' : 'limited'}">${g.signal}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <h4 style="margin-top: 1rem;">Individual Factor Scores (11 Factors):</h4>
                            <table class="data-table">
                                <thead>
                                    <tr><th>Factor</th><th>Score</th><th>Signal</th><th>Data Source</th></tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(data.score_validation?.factor_scores || {}).map(([name, f]) => {
                                        const quality = data.score_validation?.factor_data_quality?.[name] || f.data_quality || 'UNKNOWN';
                                        const qualityColor = quality === 'REAL' || quality === 'HIGH' ? 'var(--accent-green)' :
                                                           quality === 'MEDIUM' || quality === 'CALCULATED' || quality === 'SCHEDULED' ? '#f59e0b' :
                                                           quality === 'FALLBACK' || quality === 'NO_DATA' ? 'var(--accent-red)' : 'var(--text-muted)';
                                        const qualityIcon = quality === 'REAL' || quality === 'HIGH' ? '✓' :
                                                          quality === 'MEDIUM' || quality === 'CALCULATED' ? '~' :
                                                          quality === 'SCHEDULED' ? '📅' : '⚠';
                                        const qualityLabel = quality === 'SCHEDULED' ? 'SCHEDULE' : quality;
                                        return `
                                        <tr>
                                            <td style="text-transform: capitalize;">${name}</td>
                                            <td style="color: ${f.score >= 58 ? 'var(--accent-green)' : f.score <= 42 ? 'var(--accent-red)' : 'var(--text-primary)'}; font-weight: 600;">${f.score}</td>
                                            <td><span class="status-badge ${f.signal === 'BULLISH' ? 'ok' : f.signal === 'BEARISH' ? 'error' : 'limited'}">${f.signal}</span></td>
                                            <td style="color: ${qualityColor}; font-weight: 500;">${qualityIcon} ${qualityLabel}</td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 6px; font-size: 0.8rem;">
                                <strong>Data Quality Legend:</strong> 
                                <span style="color: var(--accent-green);">✓ REAL</span> = Live API data | 
                                <span style="color: #f59e0b;">📅 SCHEDULE</span> = Real recurring events | 
                                <span style="color: #f59e0b;">~ MEDIUM</span> = Partial data | 
                                <span style="color: var(--accent-red);">⚠ FALLBACK</span> = Static placeholder
                            </div>
                            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: 8px;">
                                <strong>v9.2.2 Conviction:</strong>
                                Score ${data.score_validation?.conviction_v9?.score || 0} (${data.score_validation?.conviction_v9?.label || 'N/A'}) |
                                <strong>Breadth:</strong> ${((data.score_validation?.conviction_v9?.breadth || 0) * 100).toFixed(0)}% |
                                <strong>Groups:</strong> ${data.score_validation?.conviction_v9?.bullish_groups || 0} Bullish, ${data.score_validation?.conviction_v9?.bearish_groups || 0} Bearish |
                                <strong>Gates:</strong> ${data.score_validation?.gates?.passed || 0}/${data.score_validation?.gates?.total || 8} (G3/G5/G8 mandatory) |
                                <strong>Regime:</strong> ${data.score_validation?.regime || 'N/A'}
                            </div>
                        </div>
                        
                        <div class="audit-section">
                            <h3>⚙️ Scoring Methodology Summary</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                <div class="result-card">
                                    <div class="value">${data.scoring_methodology?.score_range?.min || 5} - ${data.scoring_methodology?.score_range?.max || 95}</div>
                                    <div class="label">Score Range</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">≥${data.scoring_methodology?.score_range?.bullish_threshold || 65}</div>
                                    <div class="label">LONG Threshold</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">≤${data.scoring_methodology?.score_range?.bearish_threshold || 35}</div>
                                    <div class="label">SHORT Threshold</div>
                                </div>
                            </div>
                            <p style="margin-top: 1rem; color: var(--text-secondary);">
                                <strong>Conviction Metric:</strong> Separate breadth x strength score (0-100) — not a score amplifier.
                                <br><strong>Agreement Expansion:</strong> +2 pts per agreeing group beyond 2 (max +8) to counter neutral-group dilution.
                                <br><strong>Quality Gates:</strong> 6 of 8 gates must pass + G3/G5/G8 mandatory for directional signal (otherwise NEUTRAL).
                            </p>
                            <button onclick="showMethodology()" style="margin-top: 1rem;">📖 View Full Methodology Details</button>
                        </div>
                        
                        <div class="audit-section" style="border: 2px solid ${data.scoring_quality?.quality_status === 'EXCELLENT' ? 'var(--accent-green)' : data.scoring_quality?.quality_status === 'GOOD' ? 'var(--accent-blue)' : 'var(--accent-yellow)'};">
                            <h3>🔬 Scoring Quality Validation (REAL DATA CHECK)</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                <div class="result-card">
                                    <div class="value" style="color: ${data.scoring_quality?.quality_score >= 90 ? 'var(--accent-green)' : data.scoring_quality?.quality_score >= 70 ? 'var(--accent-blue)' : 'var(--accent-yellow)'};">${data.scoring_quality?.quality_score || 0}%</div>
                                    <div class="label">Quality Score</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">${data.scoring_quality?.quality_status || 'N/A'}</div>
                                    <div class="label">Status</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">${data.scoring_quality?.score_statistics?.range || 0}</div>
                                    <div class="label">Score Range</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">${data.scoring_quality?.score_statistics?.std_dev || 0}</div>
                                    <div class="label">Std Dev</div>
                                </div>
                            </div>
                            
                            <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Multi-Pair Test Results:</h4>
                            <table class="data-table">
                                <thead><tr><th>Pair</th><th>Score</th><th>Direction</th><th>Factors</th></tr></thead>
                                <tbody>
                                    ${(data.scoring_quality?.test_pairs || []).map(p => `
                                        <tr>
                                            <td>${p.pair}</td>
                                            <td style="color: ${p.score >= 60 ? 'var(--accent-green)' : p.score <= 40 ? 'var(--accent-red)' : 'var(--text-primary)'}; font-weight: 600;">${p.score || p.error || 'N/A'}</td>
                                            <td><span class="status-badge ${p.direction === 'LONG' ? 'ok' : p.direction === 'SHORT' ? 'error' : 'limited'}">${p.direction || '-'}</span></td>
                                            <td>${p.factors_count || 0}/7</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            
                            <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Quality Checks:</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${Object.entries(data.scoring_quality?.quality_checks || {}).map(([check, passed]) => `
                                    <span style="background: ${passed ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">
                                        ${passed ? '✅' : '❌'} ${check.replace(/_/g, ' ')}
                                    </span>
                                `).join('')}
                            </div>
                            
                            <div style="margin-top: 0.75rem; padding: 0.5rem 0.75rem; background: ${data.scoring_quality?.signal_status?.has_directional_signals ? 'rgba(16, 185, 129, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; border-radius: 8px; border-left: 3px solid ${data.scoring_quality?.signal_status?.has_directional_signals ? 'var(--accent-green)' : '#f59e0b'};">
                                <strong>${data.scoring_quality?.signal_status?.has_directional_signals ? '📈 Directional Signals:' : '📊 Market Status:'}</strong>
                                <span style="margin-left: 0.5rem; color: var(--text-secondary);">${data.scoring_quality?.signal_status?.signal_note || 'Checking...'}</span>
                            </div>
                            
                            <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Factor Data Sources (REAL):</h4>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                                ${Object.entries(data.scoring_quality?.data_verification || {}).map(([factor, source]) => `
                                    <div><strong>${factor}:</strong> ${source}</div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="audit-section">
                            <h3>🎯 Features Enabled</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${(data.system_info?.features || []).map(f => `<span style="background: var(--bg-tertiary); padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem;">✅ ${f}</span>`).join('')}
                            </div>
                        </div>
                        
                        <p style="color: var(--text-muted); margin-top: 1rem;">Audit completed at: ${data.timestamp}</p>
                    `;
                }
            } catch (error) {
                container.innerHTML = '<p style="color: var(--accent-red);">Error running audit: ' + error.message + '</p>';
            }
        }
        
        async function showMethodology() {
            const container = document.getElementById('audit-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading methodology...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/audit`);
                const data = await response.json();
                
                if (data.success && data.factor_details) {
                    const factors = data.factor_details;
                    container.innerHTML = `
                        <div class="audit-section">
                            <h3>📖 Complete Scoring Methodology - v9.2.2 PRO (8-Gate Protected)</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                This system merges 11 individual factors into <strong>8 independent groups</strong> (incl. Currency Strength from 45-pair analysis) with <strong>regime-dynamic weights</strong>, an <strong>8-gate quality filter</strong> (incl. AI alignment + data quality), and a separate <strong>conviction metric</strong> (breadth x strength).
                                All calculations use <strong>100% REAL market data + AI analysis</strong>. <strong style="color: #ef4444;">3 gates are MANDATORY (G3 Trend, G5 Calendar, G8 Data)</strong>.
                            </p>
                        </div>

                        <div class="audit-section">
                            <h3>📦 8 Factor Groups (Regime-Weighted) - v9.2.2</h3>
                            <table class="data-table">
                                <thead><tr><th>Group</th><th>Default Weight</th><th>Sources</th></tr></thead>
                                <tbody>
                                    <tr><td><strong>Trend & Momentum</strong></td><td style="font-weight: 600;">21%</td><td>Technical (RSI/MACD/ADX) 60% + MTF (H1/H4/D1) 40%</td></tr>
                                    <tr><td><strong>Fundamental</strong></td><td style="font-weight: 600;">15%</td><td>Interest rate differentials + FRED macro data</td></tr>
                                    <tr><td><strong>Sentiment</strong></td><td style="font-weight: 600;">13%</td><td>IG positioning 65% + Options proxy 35%</td></tr>
                                    <tr><td><strong>Intermarket</strong></td><td style="font-weight: 600;">12%</td><td>DXY, Gold, Yields, Oil correlations</td></tr>
                                    <tr><td><strong>Mean Reversion</strong></td><td style="font-weight: 600;">11%</td><td>Quantitative (Z-Score/Bollinger) 55% + Structure (S/R) 45%</td></tr>
                                    <tr><td><strong>Calendar Risk</strong></td><td style="font-weight: 600;">8%</td><td>Economic events + Seasonality</td></tr>
                                    <tr><td><strong>AI Synthesis</strong></td><td style="font-weight: 600;">10%</td><td>GPT enhanced analysis — activates when 2+ groups agree</td></tr>
                                    <tr style="background: rgba(139, 92, 246, 0.1);"><td><strong>Currency Strength</strong> <span style="color: #a78bfa; font-size: 0.7rem;">NEW</span></td><td style="font-weight: 600; color: #a78bfa;">10%</td><td>45-pair analysis — base vs quote currency relative strength</td></tr>
                                </tbody>
                            </table>
                            <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                                Weights shift dynamically based on detected market regime (trending, ranging, volatile, quiet).
                            </p>
                        </div>

                        <div class="audit-section">
                            <h3>🚦 8-Gate Quality Filter</h3>
                            <table class="data-table">
                                <thead><tr><th>Gate</th><th>Rule</th></tr></thead>
                                <tbody>
                                    <tr><td><strong>G1</strong></td><td>Composite score ≥ 60 (LONG) or ≤ 40 (SHORT)</td></tr>
                                    <tr><td><strong>G2</strong></td><td>≥ 3 of 8 groups agree on direction</td></tr>
                                    <tr><td><strong>G3</strong> <span style="color: #ef4444; font-size: 0.7rem;">MANDATORY</span></td><td>Trend & Momentum + EMA must CONFIRM direction (score &gt;52 for LONG, &lt;48 for SHORT)</td></tr>
                                    <tr><td><strong>G4</strong></td><td>Risk:Reward ≥ 1.3:1</td></tr>
                                    <tr><td><strong>G5</strong> <span style="color: #ef4444; font-size: 0.7rem;">MANDATORY</span></td><td>No high-impact calendar event imminent</td></tr>
                                    <tr><td><strong>G6</strong></td><td>ATR between 0.5x–2.5x of 20-period average</td></tr>
                                    <tr><td><strong>G7</strong></td><td>AI must not strongly contradict (AI ≤60 for SHORT, ≥40 for LONG)</td></tr>
                                    <tr><td><strong>G8</strong> <span style="color: #ef4444; font-size: 0.7rem;">MANDATORY</span></td><td style="color: #ef4444;"><strong>Technical data must be REAL</strong> (not fallback/estimated)</td></tr>
                                </tbody>
                            </table>
                            <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                                <strong>6 of 8 gates required</strong> for directional signal + <strong style="color: #ef4444;">G3, G5, G8 are MANDATORY</strong>. Allows 2 non-mandatory gates to fail.<br>
                                <strong>Agreement Expansion:</strong> +2 pts per agreeing group beyond 2 (max +8) to counter neutral-group dilution.
                            </p>
                        </div>

                        <div class="audit-section">
                            <h3>📊 Conviction Metric (Separate from Score)</h3>
                            <table class="data-table">
                                <thead><tr><th>Range</th><th>Label</th><th>Meaning</th></tr></thead>
                                <tbody>
                                    <tr><td>70+</td><td style="color: var(--accent-green); font-weight: 600;">VERY HIGH</td><td>Most groups agree strongly</td></tr>
                                    <tr><td>50–70</td><td style="color: var(--accent-green);">HIGH</td><td>Solid agreement</td></tr>
                                    <tr><td>30–50</td><td style="color: var(--accent-yellow);">MODERATE</td><td>Mixed agreement</td></tr>
                                    <tr><td>&lt;30</td><td style="color: var(--text-muted);">LOW</td><td>Weak agreement</td></tr>
                                </tbody>
                            </table>
                            <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                                Formula: <strong>breadth x strength</strong> — fraction of agreeing groups multiplied by their average deviation from 50. Not a score amplifier.
                            </p>
                        </div>

                        <div class="audit-section">
                            <h3>🌍 Market Regime Detection</h3>
                            <table class="data-table">
                                <thead><tr><th>Regime</th><th>Condition</th><th>Weight Shift</th></tr></thead>
                                <tbody>
                                    <tr><td style="color: var(--accent-green); font-weight: 600;">Trending</td><td>ADX ≥ 25, volatility ≥ 0.4%</td><td>Trend & Momentum → 30%</td></tr>
                                    <tr><td style="color: var(--accent-yellow); font-weight: 600;">Ranging</td><td>ADX &lt; 20, moderate vol</td><td>Mean Reversion → 25%</td></tr>
                                    <tr><td style="color: var(--accent-red); font-weight: 600;">Volatile</td><td>High ATR</td><td>Sentiment → 20%</td></tr>
                                    <tr><td style="color: var(--accent-blue); font-weight: 600;">Quiet</td><td>Low ATR, low ADX</td><td>Fundamental → 20%</td></tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="audit-section">
                            <h3>📈 Realistic Stat Caps (FXCM 43M Trade Study)</h3>
                            <table class="data-table">
                                <thead><tr><th>Stat</th><th>Cap</th><th>Rationale</th></tr></thead>
                                <tbody>
                                    <tr><td>Win Rate</td><td style="font-weight: 600;">65%</td><td>Retail traders win &gt;50% but lose money due to R:R</td></tr>
                                    <tr><td>Profit Factor</td><td style="font-weight: 600;">2.5</td><td>Professional benchmark ceiling</td></tr>
                                    <tr><td>Expectancy</td><td style="font-weight: 600;">80%</td><td>Per-trade edge limit</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="audit-section">
                            <details>
                                <summary style="cursor: pointer; color: var(--accent-blue); font-size: 1.1rem; font-weight: 600;">📋 Individual Factor Details (11 Underlying Factors — merged into 7 groups above)</summary>
                                <p style="color: var(--text-secondary); margin: 0.75rem 0; font-size: 0.85rem;">These 11 factors are the raw inputs that feed into the 7 factor groups. Click each to see scoring details.</p>
                        </div>

                        ${Object.entries(factors).map(([name, f]) => `
                            <div class="audit-section" style="border-left: 4px solid var(--accent-blue); padding-left: 1rem;">
                                <h3 style="text-transform: capitalize;">${name === 'mtf' ? 'MTF (Multi-Timeframe)' : name} - ${f.weight_percent}</h3>
                                <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">${f.description}</p>
                                <p style="font-size: 0.85rem;"><strong>Score Range:</strong> ${f.score_range} | <strong>Data Sources:</strong> ${f.data_sources?.join(', ') || 'Calculated'}</p>
                                
                                ${f.components ? `
                                    <div style="margin-top: 0.75rem;">
                                        ${Object.entries(f.components).map(([cname, comp]) => `
                                            <div style="background: var(--bg-tertiary); padding: 0.75rem; border-radius: 8px; margin-bottom: 0.5rem;">
                                                <strong>${cname.replace('_', ' ')}:</strong> ${comp.description || ''}
                                                ${comp.scoring ? `
                                                    <table class="data-table" style="margin-top: 0.5rem; font-size: 0.85rem;">
                                                        <thead><tr><th>Condition</th><th>Points/Effect</th><th>Meaning</th></tr></thead>
                                                        <tbody>
                                                            ${comp.scoring.slice(0, 6).map(s => `
                                                                <tr>
                                                                    <td>${s.condition}</td>
                                                                    <td style="color: ${(s.points || '').includes('+') ? 'var(--accent-green)' : (s.points || '').includes('-') ? 'var(--accent-red)' : 'var(--text-primary)'}; font-weight: 600;">${s.points || s.multiplier || ''}</td>
                                                                    <td>${s.meaning}</td>
                                                                </tr>
                                                            `).join('')}
                                                        </tbody>
                                                    </table>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                
                                ${f.scoring && !f.components ? `
                                    <table class="data-table" style="margin-top: 0.5rem; font-size: 0.85rem;">
                                        <thead><tr><th>Condition</th><th>Score</th><th>Meaning</th></tr></thead>
                                        <tbody>
                                            ${f.scoring.slice(0, 8).map(s => `
                                                <tr>
                                                    <td>${s.differential || s.alignment || s.factors_bullish || s.factors_bearish || s.condition || '-'}</td>
                                                    <td style="font-weight: 600;">${s.score}</td>
                                                    <td>${s.meaning || s.strength || ''}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : ''}
                                
                                ${f.central_bank_rates ? `
                                    <details style="margin-top: 0.75rem;">
                                        <summary style="cursor: pointer; color: var(--accent-blue);">View Central Bank Rates</summary>
                                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-top: 0.5rem; font-size: 0.85rem;">
                                            ${Object.entries(f.central_bank_rates).map(([cur, rate]) => `
                                                <div style="background: var(--bg-tertiary); padding: 0.25rem 0.5rem; border-radius: 4px;">
                                                    <strong>${cur}:</strong> ${rate}%
                                                </div>
                                            `).join('')}
                                        </div>
                                    </details>
                                ` : ''}
                                
                                <p style="margin-top: 0.5rem; font-size: 0.85rem;">
                                    <strong>Thresholds:</strong> 
                                    <span style="color: var(--accent-green);">BULLISH ${f.signal_thresholds?.bullish || '>= 58'}</span> | 
                                    <span style="color: var(--accent-red);">BEARISH ${f.signal_thresholds?.bearish || '<= 42'}</span> | 
                                    <span>NEUTRAL ${f.signal_thresholds?.neutral || '43-57'}</span>
                                </p>
                            </div>
                        `).join('')}

                            </details>

                        <div class="audit-section">
                            <h3>⭐ Star Rating System</h3>
                            <table class="data-table">
                                <thead><tr><th>Deviation from 50</th><th>Stars</th><th>Meaning</th></tr></thead>
                                <tbody>
                                    <tr><td>≥ 35 points</td><td>⭐⭐⭐⭐⭐</td><td>Extreme signal</td></tr>
                                    <tr><td>≥ 25 points</td><td>⭐⭐⭐⭐</td><td>Strong signal</td></tr>
                                    <tr><td>≥ 18 points</td><td>⭐⭐⭐</td><td>Moderate signal</td></tr>
                                    <tr><td>≥ 10 points</td><td>⭐⭐</td><td>Weak signal</td></tr>
                                    <tr><td>< 10 points</td><td>⭐</td><td>Very weak signal</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="audit-section" style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px;">
                            <h3>✅ Data Integrity Statement</h3>
                            <p>All scoring calculations use <strong>real market data</strong> from verified sources:</p>
                            <ul style="margin-left: 1.5rem; color: var(--text-secondary);">
                                <li>Price data from Polygon.io (real-time forex rates)</li>
                                <li>Technical indicators calculated from actual candle data</li>
                                <li>Interest rates from central bank publications</li>
                                <li>Sentiment from IG Markets client positioning</li>
                                <li>News from Finnhub API and RSS feeds</li>
                            </ul>
                            <p style="margin-top: 0.5rem;"><strong>NO fake data, NO simulated scores, NO artificial inflation.</strong></p>
                        </div>
                        
                        <button onclick="runAudit()" style="margin-top: 1rem;">← Back to Audit Results</button>
                    `;
                }
            } catch (error) {
                container.innerHTML = '<p style="color: var(--accent-red);">Error loading methodology</p>';
            }
        }
        
        // v9.0: Signal Accuracy Evaluation (90 Days)
        async function runSignalEvaluation() {
            const container = document.getElementById('audit-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Evaluating 90-day signal history against actual prices...</div>';

            try {
                const response = await fetch(`${API_BASE}/signal-evaluation`);
                const data = await response.json();

                if (data.success && data.summary) {
                    const s = data.summary;
                    const o = s.overall || {};
                    const evalRun = data.evaluation_run || {};

                    container.innerHTML = `
                        <div class="audit-section" style="border-left: 3px solid #8b5cf6; padding-left: 1rem; margin-bottom: 2rem;">
                            <h3 style="color: #8b5cf6;">📊 Signal Accuracy Report - Last 90 Days</h3>
                            <p style="color: var(--text-muted); margin-bottom: 1rem;">
                                Evaluated ${evalRun.evaluated || 0} new signals this run |
                                Total evaluated: ${o.total_evaluated || 0} |
                                Generated: ${data.timestamp || 'N/A'}
                            </p>

                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                <div class="result-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                    <div style="font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: ${o.accuracy_pct >= 55 ? 'var(--accent-green)' : o.accuracy_pct >= 45 ? '#ffaa00' : 'var(--accent-red)'};">${o.accuracy_pct || 0}%</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Overall Accuracy</div>
                                </div>
                                <div class="result-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                    <div style="font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace;">${o.total_evaluated || 0}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Signals Evaluated</div>
                                </div>
                                <div class="result-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                    <div style="font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent-green);">${o.correct || 0}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Correct Signals</div>
                                </div>
                                <div class="result-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                    <div style="font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent-red);">${o.incorrect || 0}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Incorrect Signals</div>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                <div class="result-card" style="text-align: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--accent-green);">${o.tp1_hit_rate || 0}%</div>
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">TP1 HIT RATE</div>
                                </div>
                                <div class="result-card" style="text-align: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--accent-green);">${o.tp2_hit_rate || 0}%</div>
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">TP2 HIT RATE</div>
                                </div>
                                <div class="result-card" style="text-align: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--accent-red);">${o.sl_hit_rate || 0}%</div>
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">SL HIT RATE</div>
                                </div>
                                <div class="result-card" style="text-align: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                    <div style="font-size: 1.2rem; font-weight: 600;">${o.avg_pips || 0}</div>
                                    <div style="font-size: 0.65rem; color: var(--text-muted);">AVG PIPS</div>
                                </div>
                            </div>
                        </div>

                        ${(s.by_direction || []).length > 0 ? `
                        <div class="audit-section" style="margin-bottom: 1.5rem;">
                            <h3>📈 Accuracy by Direction</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
                                <thead><tr style="border-bottom: 1px solid var(--border-color);">
                                    <th style="text-align: left; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">DIRECTION</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">TOTAL</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">CORRECT</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">ACCURACY</th>
                                </tr></thead>
                                <tbody>
                                    ${s.by_direction.map(d => `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                            <td style="padding: 0.5rem; font-weight: 600; color: ${d.direction === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)'};">${d.direction}</td>
                                            <td style="padding: 0.5rem; text-align: center;">${d.total}</td>
                                            <td style="padding: 0.5rem; text-align: center; color: var(--accent-green);">${d.correct}</td>
                                            <td style="padding: 0.5rem; text-align: center; font-weight: 600;">${d.accuracy_pct}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>` : ''}

                        ${(s.by_score_bracket || []).length > 0 ? `
                        <div class="audit-section" style="margin-bottom: 1.5rem;">
                            <h3>🎯 Accuracy by Signal Strength</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
                                <thead><tr style="border-bottom: 1px solid var(--border-color);">
                                    <th style="text-align: left; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">BRACKET</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">TOTAL</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">CORRECT</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">ACCURACY</th>
                                </tr></thead>
                                <tbody>
                                    ${s.by_score_bracket.map(b => `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                            <td style="padding: 0.5rem; font-weight: 600;">${b.score_bracket}</td>
                                            <td style="padding: 0.5rem; text-align: center;">${b.total}</td>
                                            <td style="padding: 0.5rem; text-align: center; color: var(--accent-green);">${b.correct}</td>
                                            <td style="padding: 0.5rem; text-align: center; font-weight: 600;">${b.accuracy_pct}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>` : ''}

                        ${(s.by_grade || []).length > 0 ? `
                        <div class="audit-section" style="margin-bottom: 1.5rem;">
                            <h3>🏅 Accuracy by Trade Grade</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
                                <thead><tr style="border-bottom: 1px solid var(--border-color);">
                                    <th style="text-align: left; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">GRADE</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">TOTAL</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">CORRECT</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">ACCURACY</th>
                                </tr></thead>
                                <tbody>
                                    ${s.by_grade.map(g => `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                            <td style="padding: 0.5rem; font-weight: 600;">${g.grade}</td>
                                            <td style="padding: 0.5rem; text-align: center;">${g.total}</td>
                                            <td style="padding: 0.5rem; text-align: center; color: var(--accent-green);">${g.correct}</td>
                                            <td style="padding: 0.5rem; text-align: center; font-weight: 600;">${g.accuracy_pct}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>` : ''}

                        <div class="audit-section" style="margin-bottom: 1.5rem;">
                            <h3>🏆 Best Performing Pairs</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
                                <thead><tr style="border-bottom: 1px solid var(--border-color);">
                                    <th style="text-align: left; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">PAIR</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">ACCURACY</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">CORRECT</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">INCORRECT</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">AVG PIPS</th>
                                </tr></thead>
                                <tbody>
                                    ${(s.best_pairs || []).map(p => `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                            <td style="padding: 0.5rem; font-weight: 600;">${p.pair}</td>
                                            <td style="padding: 0.5rem; text-align: center; color: var(--accent-green); font-weight: 600;">${p.accuracy_pct}%</td>
                                            <td style="padding: 0.5rem; text-align: center;">${p.correct}</td>
                                            <td style="padding: 0.5rem; text-align: center;">${p.incorrect}</td>
                                            <td style="padding: 0.5rem; text-align: center;">${(p.avg_pips || 0).toFixed(1)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div class="audit-section" style="margin-bottom: 1.5rem;">
                            <h3>📉 Worst Performing Pairs</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
                                <thead><tr style="border-bottom: 1px solid var(--border-color);">
                                    <th style="text-align: left; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">PAIR</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">ACCURACY</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">CORRECT</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">INCORRECT</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">AVG PIPS</th>
                                </tr></thead>
                                <tbody>
                                    ${(s.worst_pairs || []).map(p => `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                            <td style="padding: 0.5rem; font-weight: 600;">${p.pair}</td>
                                            <td style="padding: 0.5rem; text-align: center; color: var(--accent-red); font-weight: 600;">${p.accuracy_pct}%</td>
                                            <td style="padding: 0.5rem; text-align: center;">${p.correct}</td>
                                            <td style="padding: 0.5rem; text-align: center;">${p.incorrect}</td>
                                            <td style="padding: 0.5rem; text-align: center;">${(p.avg_pips || 0).toFixed(1)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div class="audit-section">
                            <h3>📋 Full Per-Pair Breakdown</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
                                <thead><tr style="border-bottom: 1px solid var(--border-color);">
                                    <th style="text-align: left; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">PAIR</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">TOTAL</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">CORRECT</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">INCORRECT</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">PARTIAL</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">ACCURACY</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">AVG PIPS</th>
                                </tr></thead>
                                <tbody>
                                    ${(s.per_pair || []).map(p => `
                                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                            <td style="padding: 0.5rem; font-weight: 600;">${p.pair}</td>
                                            <td style="padding: 0.5rem; text-align: center;">${p.total}</td>
                                            <td style="padding: 0.5rem; text-align: center; color: var(--accent-green);">${p.correct}</td>
                                            <td style="padding: 0.5rem; text-align: center; color: var(--accent-red);">${p.incorrect}</td>
                                            <td style="padding: 0.5rem; text-align: center; color: #ffaa00;">${p.partial || 0}</td>
                                            <td style="padding: 0.5rem; text-align: center; font-weight: 600; color: ${p.accuracy_pct >= 55 ? 'var(--accent-green)' : p.accuracy_pct >= 45 ? '#ffaa00' : 'var(--accent-red)'};">${p.accuracy_pct}%</td>
                                            <td style="padding: 0.5rem; text-align: center;">${(p.avg_pips || 0).toFixed(1)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No evaluation data available yet. Signals need at least 3 days of history to be evaluated.</div>';
                }
            } catch (error) {
                container.innerHTML = '<div style="padding: 1rem; color: var(--accent-red);">Error loading signal evaluation: ' + error.message + '</div>';
            }
        }

        // v9.0: AI Performance Monitor & Optimizer
        async function showAIInsights() {
            const container = document.getElementById('audit-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing factor performance with AI Supervisor...</div>';

            // Switch to audit tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="audit"]').classList.add('active');
            document.getElementById('tab-audit').classList.add('active');

            try {
                const response = await fetch(`${API_BASE}/ai-insights`);
                const data = await response.json();

                if (data.success) {
                    const fp = data.factor_performance || {};
                    const ai = data.ai_recommendations || {};
                    const summary = data.insights_summary || {};

                    // Build factor performance table
                    let factorTableHtml = Object.entries(fp).filter(([k, v]) => typeof v === 'object' && v.overall_win_rate !== undefined).map(([name, d]) => `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 0.5rem; font-weight: 600; text-transform: capitalize;">${name.replace(/_/g, ' ')}</td>
                            <td style="padding: 0.5rem; text-align: center;">${d.current_weight}%</td>
                            <td style="padding: 0.5rem; text-align: center;">${d.total_signals}</td>
                            <td style="padding: 0.5rem; text-align: center; color: ${d.overall_win_rate >= 55 ? 'var(--accent-green)' : d.overall_win_rate >= 45 ? '#ffaa00' : 'var(--accent-red)'}; font-weight: 600;">${d.overall_win_rate}%</td>
                            <td style="padding: 0.5rem; text-align: center; color: var(--accent-green);">${d.bullish?.win_rate || 0}%</td>
                            <td style="padding: 0.5rem; text-align: center; color: var(--accent-red);">${d.bearish?.win_rate || 0}%</td>
                        </tr>
                    `).join('');

                    // Build AI recommendations
                    let aiRecsHtml = '';
                    if (ai.status === 'success') {
                        const weightSuggestions = (ai.weight_suggestions || []).map(w => `
                            <div style="display: flex; align-items: center; gap: 1rem; padding: 0.5rem; background: rgba(255,255,255,0.03); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-weight: 600; text-transform: capitalize; min-width: 120px;">${(w.factor || '').replace(/_/g, ' ')}</span>
                                <span style="color: var(--text-muted);">${w.current}%</span>
                                <span style="color: #8b5cf6;">→</span>
                                <span style="color: ${w.suggested > w.current ? 'var(--accent-green)' : 'var(--accent-red)'}; font-weight: 600;">${w.suggested}%</span>
                                <span style="font-size: 0.8rem; color: var(--text-secondary); flex: 1;">${w.reason || ''}</span>
                            </div>
                        `).join('');

                        const actionItems = (ai.action_items || []).map(a => `
                            <li style="margin-bottom: 0.3rem; color: var(--text-secondary);">${a}</li>
                        `).join('');

                        const warnings = (ai.risk_warnings || []).map(w => `
                            <div style="padding: 0.5rem; background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; margin-bottom: 0.5rem; border-radius: 0 0.25rem 0.25rem 0;">
                                <span style="color: #ef4444;">⚠️</span> ${w}
                            </div>
                        `).join('');

                        aiRecsHtml = `
                            <div class="audit-section" style="border-left: 3px solid #8b5cf6; padding-left: 1rem; margin-bottom: 2rem;">
                                <h3 style="color: #8b5cf6; display: flex; align-items: center; gap: 0.5rem;">
                                    🤖 AI Supervisor Recommendations
                                    <span style="font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 1rem; background: rgba(139, 92, 246, 0.2); color: #a78bfa;">
                                        Confidence: ${ai.confidence_score || 0}%
                                    </span>
                                </h3>
                                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-style: italic;">"${ai.overall_assessment || 'No assessment available'}"</p>

                                ${weightSuggestions ? `
                                <div style="margin-bottom: 1.5rem;">
                                    <h4 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">💡 Suggested Weight Adjustments</h4>
                                    ${weightSuggestions}
                                </div>` : ''}

                                ${(ai.top_performers || []).length > 0 ? `
                                <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
                                    <div>
                                        <span style="font-size: 0.8rem; color: var(--text-muted);">Top Performers:</span>
                                        ${ai.top_performers.map(p => `<span style="margin-left: 0.5rem; padding: 0.2rem 0.5rem; background: rgba(52, 211, 153, 0.2); color: #34d399; border-radius: 0.25rem; font-size: 0.8rem; text-transform: capitalize;">${p.replace(/_/g, ' ')}</span>`).join('')}
                                    </div>
                                    ${(ai.underperformers || []).length > 0 ? `
                                    <div>
                                        <span style="font-size: 0.8rem; color: var(--text-muted);">Underperformers:</span>
                                        ${ai.underperformers.map(p => `<span style="margin-left: 0.5rem; padding: 0.2rem 0.5rem; background: rgba(239, 68, 68, 0.2); color: #ef4444; border-radius: 0.25rem; font-size: 0.8rem; text-transform: capitalize;">${p.replace(/_/g, ' ')}</span>`).join('')}
                                    </div>` : ''}
                                </div>` : ''}

                                ${warnings ? `<div style="margin-bottom: 1rem;">${warnings}</div>` : ''}

                                ${actionItems ? `
                                <div style="margin-bottom: 1rem;">
                                    <h4 style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;">📋 Action Items</h4>
                                    <ul style="margin: 0; padding-left: 1.5rem;">${actionItems}</ul>
                                </div>` : ''}

                                <p style="font-size: 0.75rem; color: var(--text-muted);">Model: ${data.model_used || 'gpt-4o-mini'} | Generated: ${ai.timestamp || data.timestamp || 'N/A'}</p>
                            </div>
                        `;
                    } else {
                        aiRecsHtml = `
                            <div class="audit-section" style="border-left: 3px solid #ffaa00; padding-left: 1rem; margin-bottom: 2rem;">
                                <h3 style="color: #ffaa00;">🤖 AI Supervisor</h3>
                                <p style="color: var(--text-secondary);">Status: ${ai.status || 'unavailable'}</p>
                                <p style="color: var(--text-muted);">${ai.message || ai.reason || 'AI analysis not available. Ensure OpenAI API key is configured.'}</p>
                            </div>
                        `;
                    }

                    container.innerHTML = `
                        <div class="audit-section" style="border-left: 3px solid #3b82f6; padding-left: 1rem; margin-bottom: 2rem;">
                            <h3 style="color: #3b82f6;">📊 AI Performance Monitor</h3>
                            <p style="color: var(--text-muted); margin-bottom: 1rem;">
                                Analyzing factor win rates from 90-day signal evaluation data to optimize weights.
                            </p>

                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                <div class="result-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                    <div style="font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent-green);">${summary.avg_system_win_rate || 0}%</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">System Win Rate</div>
                                </div>
                                <div class="result-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #34d399; text-transform: capitalize;">${(summary.best_performing_factor?.name || 'N/A').replace(/_/g, ' ')}</div>
                                    <div style="font-size: 0.85rem; color: var(--accent-green);">${summary.best_performing_factor?.win_rate || 0}% WR</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Best Factor</div>
                                </div>
                                <div class="result-card" style="text-align: center; padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #ef4444; text-transform: capitalize;">${(summary.worst_performing_factor?.name || 'N/A').replace(/_/g, ' ')}</div>
                                    <div style="font-size: 0.85rem; color: var(--accent-red);">${summary.worst_performing_factor?.win_rate || 0}% WR</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase;">Needs Improvement</div>
                                </div>
                            </div>

                            <h4 style="margin-bottom: 0.5rem;">Factor Group Performance</h4>
                            <table style="width: 100%; border-collapse: collapse; margin-top: 0.5rem;">
                                <thead><tr style="border-bottom: 1px solid var(--border-color);">
                                    <th style="text-align: left; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">FACTOR GROUP</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">WEIGHT</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">SIGNALS</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">WIN RATE</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">BULLISH WR</th>
                                    <th style="text-align: center; padding: 0.5rem; font-size: 0.75rem; color: var(--text-muted);">BEARISH WR</th>
                                </tr></thead>
                                <tbody>${factorTableHtml}</tbody>
                            </table>
                        </div>

                        ${aiRecsHtml}

                        <div style="text-align: center; margin-top: 1rem;">
                            <button onclick="showAIInsights()" style="background: linear-gradient(135deg, #8b5cf6, #3b82f6);">🔄 Refresh AI Analysis</button>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-secondary);">No AI insights available. Need evaluated signals to analyze performance.</div>';
                }
            } catch (error) {
                container.innerHTML = '<div style="padding: 1rem; color: var(--accent-red);">Error loading AI insights: ' + error.message + '</div>';
            }
        }

        // Load API Status
        async function loadApiStatus() {
            try {
                const response = await fetch(`${API_BASE}/api-status`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('api-status-container');
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            ${Object.entries(data).filter(([k]) => k !== 'success').map(([name, info]) => `
                                <div class="result-card">
                                    <div class="value">
                                        <span class="status-badge ${info.status === 'OK' ? 'ok' : ['NOT_CONFIGURED', 'RATE_LIMITED', 'SCHEDULED'].includes(info.status) ? 'limited' : 'error'}">
                                            ${info.status}
                                        </span>
                                    </div>
                                    <div class="label">${name.toUpperCase()}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                        ${info.configured ? 'Configured' : 'Not Configured'}
                                        ${info.cooldown_min ? ` (${info.cooldown_min}m cooldown)` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading API status:', error);
            }
        }
        
        // v9.2.2: Currency Correlation Analysis
        async function showCorrelation() {
            const container = document.getElementById('audit-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing currency correlations & triangle deviations...</div>';

            // Switch to audit tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="audit"]').classList.add('active');
            document.getElementById('tab-audit').classList.add('active');

            try {
                const response = await fetch(`${API_BASE}/correlation?t=${Date.now()}`);
                const data = await response.json();

                if (data.success) {
                    const strength = data.currency_strength || {};
                    const triangles = data.triangle_deviations || [];
                    const suggestions = data.trade_suggestions || [];

                    // Build currency strength bars
                    const strengthBars = Object.entries(strength)
                        .sort((a, b) => b[1] - a[1])
                        .map(([curr, score]) => {
                            const color = score > 55 ? '#10b981' : score < 45 ? '#ef4444' : '#6b7280';
                            const width = Math.min(100, Math.max(0, score));
                            return `
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                    <span style="width: 40px; font-weight: 600;">${curr}</span>
                                    <div style="flex: 1; background: rgba(255,255,255,0.1); height: 20px; border-radius: 4px; overflow: hidden;">
                                        <div style="width: ${width}%; height: 100%; background: ${color}; display: flex; align-items: center; justify-content: flex-end; padding-right: 0.5rem;">
                                            <span style="font-size: 0.75rem; font-weight: 600;">${score.toFixed(1)}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');

                    // Build triangle deviations
                    const triangleHtml = triangles.length > 0 ? triangles.map(t => `
                        <div style="padding: 0.75rem; background: rgba(${t.direction === 'LONG' ? '16,185,129' : '239,68,68'}, 0.1); border-left: 3px solid ${t.direction === 'LONG' ? '#10b981' : '#ef4444'}; border-radius: 0 0.5rem 0.5rem 0; margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">${t.target_pair}</span>
                                <span class="status-badge ${t.direction === 'LONG' ? 'ok' : 'error'}">${t.direction}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">${t.signal}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Triangle: ${t.triangle.join(' → ')}</div>
                        </div>
                    `).join('') : '<div style="color: var(--text-muted); padding: 1rem; text-align: center;">No significant triangle deviations detected</div>';

                    // Build trade suggestions
                    const suggestionsHtml = suggestions.map(s => `
                        <div style="display: flex; align-items: center; gap: 1rem; padding: 0.5rem; background: rgba(255,255,255,0.03); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600; min-width: 80px;">${s.pair}</span>
                            <span class="status-badge ${s.direction === 'LONG' ? 'ok' : 'error'}">${s.direction}</span>
                            <span style="font-size: 0.85rem; color: var(--text-secondary); flex: 1;">${s.reason}</span>
                        </div>
                    `).join('');

                    container.innerHTML = `
                        <div class="audit-section">
                            <h3>📊 Currency Correlation Analysis (v9.2.2)</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Real-time currency strength analysis using all 45 pairs. Higher scores = stronger currency.
                            </p>
                        </div>

                        <div class="audit-section">
                            <h4 style="margin-bottom: 1rem;">💪 Currency Strength Index</h4>
                            ${strengthBars}
                            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem;">
                                <strong>Strategy:</strong> Buy pairs where strong currency is base, sell where weak currency is base.
                            </div>
                        </div>

                        <div class="audit-section">
                            <h4 style="margin-bottom: 1rem;">📐 Triangle Arbitrage Opportunities</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.85rem;">
                                Detects mispricing between related pairs. When triangle deviation exceeds 0.2%, there may be a trading opportunity.
                            </p>
                            ${triangleHtml}
                        </div>

                        <div class="audit-section">
                            <h4 style="margin-bottom: 1rem;">🎯 Strength-Based Trade Suggestions</h4>
                            ${suggestionsHtml || '<div style="color: var(--text-muted); text-align: center;">No strong suggestions at this time</div>'}
                        </div>

                        <p style="color: var(--text-muted); margin-top: 1rem; font-size: 0.85rem;">
                            Analysis completed at: ${data.timestamp || new Date().toISOString()}
                        </p>
                    `;
                } else {
                    container.innerHTML = '<div style="color: var(--accent-red); padding: 1rem;">Error loading correlation data</div>';
                }
            } catch (error) {
                console.error('Correlation analysis error:', error);
                container.innerHTML = '<div style="color: var(--accent-red); padding: 1rem;">Error: ' + error.message + '</div>';
            }
        }

        // Filter listeners
        document.getElementById('filter-category').addEventListener('change', renderSignals);
        document.getElementById('filter-direction').addEventListener('change', renderSignals);
        document.getElementById('filter-grade').addEventListener('change', renderSignals);
        document.getElementById('rates-category').addEventListener('change', loadRates);
        
        // Countdown timer - 120s auto-refresh
        function updateCountdown() {
            countdown--;
            if (countdown <= 0) {
                countdown = 120;
                // v9.2.2: Force refresh to clear server cache on auto-refresh
                loadSignals(true);
            }
            document.getElementById('refresh-countdown').textContent = `${countdown}s`;
        }

        // Update refresh timer display (called after loadSignals)
        function updateRefreshTimer() {
            if (lastSignalsUpdate) {
                const timeStr = lastSignalsUpdate.toLocaleTimeString();
                console.log(`Signals updated at ${timeStr}`);
            }
        }

        // Initialize
        loadSignals();
        setInterval(updateCountdown, 1000);

        // ═══════════════════════════════════════════════════════════════════════════
        // NATIVE APP FEATURES
        // ═══════════════════════════════════════════════════════════════════════════

        // Hide splash screen after content loads
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.getElementById('splash').classList.add('hidden');
            }, 1500);
        });

        // Mobile bottom navigation handling - syncs with main tabs
        function initMobileNav() {
            const mobileNavItems = document.querySelectorAll('.mobile-bottom-nav .nav-item');

            mobileNavItems.forEach(item => {
                item.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');

                    // Update mobile nav active state
                    mobileNavItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');

                    // Update main nav active state
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    const mainTab = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
                    if (mainTab) mainTab.classList.add('active');

                    // Show corresponding tab content
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    const tabContent = document.getElementById(`tab-${tabName}`);
                    if (tabContent) tabContent.classList.add('active');

                    // Load data for specific tabs
                    if (tabName === 'rates') loadRates();
                    else if (tabName === 'analyzer') loadAnalyzerPairs();
                    else if (tabName === 'technical') loadTechnical();
                    else if (tabName === 'positioning') loadPositioning();
                    else if (tabName === 'news') loadNews();
                    else if (tabName === 'calendar') loadCalendar(true);
                    else if (tabName === 'weights') loadWeights();
                    else if (tabName === 'api-status') loadApiStatus();
                    else if (tabName === 'audit') loadApiStatus(); // Audit uses same data

                    // Scroll to top smoothly
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });

            // Also sync mobile nav when main nav is clicked
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    mobileNavItems.forEach(item => {
                        item.classList.toggle('active', item.getAttribute('data-tab') === tabName);
                    });
                });
            });
        }

        // Pull to refresh (visual only - actual refresh handled by app)
        let touchStartY = 0;
        let isPulling = false;

        document.addEventListener('touchstart', function(e) {
            if (window.scrollY === 0) {
                touchStartY = e.touches[0].clientY;
            }
        }, { passive: true });

        document.addEventListener('touchmove', function(e) {
            if (touchStartY > 0 && window.scrollY === 0) {
                const touchY = e.touches[0].clientY;
                const diff = touchY - touchStartY;
                if (diff > 50 && !isPulling) {
                    isPulling = true;
                    document.getElementById('pull-indicator').classList.add('visible');
                }
            }
        }, { passive: true });

        document.addEventListener('touchend', function() {
            if (isPulling) {
                isPulling = false;
                document.getElementById('pull-indicator').classList.remove('visible');
                loadSignals(); // Refresh data
            }
            touchStartY = 0;
        }, { passive: true });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(function(registration) {
                console.log('ServiceWorker registration successful');
            }).catch(function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        }

        // PWA Install Prompt - Show automatically on mobile
        let deferredPrompt;
        const installBanner = document.getElementById('install-banner');
        const installBtn = document.getElementById('install-btn');
        const dismissBtn = document.getElementById('dismiss-install');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            // Show install banner
            if (installBanner) {
                installBanner.style.display = 'flex';
            }
            console.log('PWA install prompt ready');
        });

        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                // Show the install prompt
                deferredPrompt.prompt();
                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;
                console.log('PWA install outcome:', outcome);
                // Clear the deferred prompt
                deferredPrompt = null;
                // Hide the banner
                if (installBanner) {
                    installBanner.style.display = 'none';
                }
            });
        }

        if (dismissBtn) {
            dismissBtn.addEventListener('click', () => {
                if (installBanner) {
                    installBanner.style.display = 'none';
                }
                // Remember dismissal for this session
                sessionStorage.setItem('pwa-install-dismissed', 'true');
            });
        }

        // Check if already installed or dismissed
        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            if (installBanner) {
                installBanner.style.display = 'none';
            }
        });

        // iOS Safari install instructions
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        if (isIOS && !isInStandaloneMode && !sessionStorage.getItem('pwa-install-dismissed')) {
            // Show iOS-specific install instructions after 2 seconds
            setTimeout(() => {
                const iosBanner = document.getElementById('ios-install-banner');
                if (iosBanner) {
                    iosBanner.style.display = 'flex';
                }
            }, 2000);
        }
    </script>

    <!-- Mobile Bottom Navigation - All 10 Tabs -->
    <nav class="mobile-bottom-nav">
        <div class="nav-items">
            <div class="nav-item active" data-tab="overview">
                <span class="nav-icon">📊</span>
                <span class="nav-label">Overview</span>
            </div>
            <div class="nav-item" data-tab="rates">
                <span class="nav-icon">💹</span>
                <span class="nav-label">Rates</span>
            </div>
            <div class="nav-item" data-tab="analyzer">
                <span class="nav-icon">🔬</span>
                <span class="nav-label">Analyzer</span>
            </div>
            <div class="nav-item" data-tab="technical">
                <span class="nav-icon">📉</span>
                <span class="nav-label">Technical</span>
            </div>
            <div class="nav-item" data-tab="positioning">
                <span class="nav-icon">👥</span>
                <span class="nav-label">Position</span>
            </div>
            <div class="nav-item" data-tab="news">
                <span class="nav-icon">📰</span>
                <span class="nav-label">News</span>
            </div>
            <div class="nav-item" data-tab="calendar">
                <span class="nav-icon">📅</span>
                <span class="nav-label">Calendar</span>
            </div>
            <div class="nav-item" data-tab="weights">
                <span class="nav-icon">⚖️</span>
                <span class="nav-label">Weights</span>
            </div>
            <div class="nav-item" data-tab="audit">
                <span class="nav-icon">🔍</span>
                <span class="nav-label">Audit</span>
            </div>
            <div class="nav-item" data-tab="api-status">
                <span class="nav-icon">⚙️</span>
                <span class="nav-label">API</span>
            </div>
        </div>
    </nav>

    <!-- PWA Install Banner (Android/Chrome) -->
    <div id="install-banner" class="install-banner" style="display: none;">
        <div class="install-banner-content">
            <img src="/static/icon-192.png" alt="MEGA FOREX" class="install-icon">
            <div class="install-text">
                <strong>Install MEGA FOREX PRO</strong>
                <span>Add to your home screen for the best experience</span>
            </div>
        </div>
        <div class="install-buttons">
            <button id="install-btn" class="install-btn-primary">Install</button>
            <button id="dismiss-install" class="install-btn-dismiss">Not Now</button>
        </div>
    </div>

    <!-- iOS Install Instructions Banner -->
    <div id="ios-install-banner" class="install-banner ios-banner" style="display: none;">
        <div class="install-banner-content">
            <img src="/static/icon-192.png" alt="MEGA FOREX" class="install-icon">
            <div class="install-text">
                <strong>Install MEGA FOREX PRO</strong>
                <span>Tap <span style="font-size: 1.2em;">⬆️</span> then "Add to Home Screen"</span>
            </div>
        </div>
        <button onclick="this.parentElement.style.display='none'; sessionStorage.setItem('pwa-install-dismissed', 'true');" class="install-btn-dismiss" style="margin-left: auto;">✕</button>
    </div>

    <!-- Initialize Mobile Navigation (must be after nav HTML) -->
    <script>
        // Initialize mobile nav now that DOM elements exist
        initMobileNav();
    </script>
</body>
</html>
