<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEGA FOREX v8.2 PRO - Professional Trading Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a1f2e;
            --bg-hover: #252b3d;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --border-color: #374151;
            --gradient-bull: linear-gradient(135deg, #059669, #10b981);
            --gradient-bear: linear-gradient(135deg, #dc2626, #ef4444);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-blue);
        }
        
        .logo span { color: var(--accent-green); }
        
        .header-stats {
            display: flex;
            gap: 2rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border-radius: 0.5rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Navigation */
        .nav-container {
            background: var(--bg-secondary);
            padding: 0.5rem 2rem;
            overflow-x: auto;
        }
        
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }
        
        .nav-tab {
            padding: 0.75rem 1.25rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .nav-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .nav-tab.active {
            background: var(--accent-blue);
            color: white;
        }
        
        /* Main Content */
        .main-content {
            padding: 1.5rem 2rem;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Filters */
        .filters-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .filter-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        select, input {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }
        
        button {
            background: var(--accent-blue);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        button:hover {
            filter: brightness(1.1);
        }
        
        button.secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }
        
        /* Signal Cards */
        .signals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 1rem;
        }
        
        .signal-card {
            background: var(--bg-card);
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            padding: 1.25rem;
            transition: all 0.2s;
        }
        
        .signal-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .pair-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .pair-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .category-badge {
            font-size: 0.625rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .category-badge.major { background: var(--accent-blue); }
        .category-badge.cross { background: var(--accent-purple); }
        .category-badge.exotic { background: var(--accent-yellow); color: #000; }
        
        .composite-score {
            text-align: right;
        }
        
        .score-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .score-value.bullish { color: var(--accent-green); }
        .score-value.bearish { color: var(--accent-red); }
        .score-value.neutral { color: var(--text-secondary); }
        
        .stars {
            color: var(--accent-yellow);
            font-size: 0.875rem;
        }
        
        .direction-badge {
            display: inline-block;
            padding: 0.375rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .direction-badge.long {
            background: var(--gradient-bull);
            color: white;
        }
        
        .direction-badge.short {
            background: var(--gradient-bear);
            color: white;
        }
        
        .direction-badge.neutral {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }
        
        /* Statistics Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 0.5rem;
        }
        
        .stat-box {
            text-align: center;
        }
        
        .stat-box .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .stat-box .label {
            font-size: 0.625rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        /* Factor Grid */
        .factor-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.375rem;
            margin-bottom: 1rem;
        }
        
        .factor-item {
            text-align: center;
            padding: 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            font-weight: 600;
        }
        
        .factor-item.bullish { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .factor-item.bearish { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .factor-item.neutral { background: var(--bg-hover); color: var(--text-secondary); }
        
        /* Trade Setup */
        .trade-setup {
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        
        .setup-title {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .setup-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        
        .setup-item {
            text-align: center;
        }
        
        .setup-item .label {
            font-size: 0.625rem;
            color: var(--text-muted);
        }
        
        .setup-item .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .setup-item.entry .value { color: var(--accent-blue); }
        .setup-item.sl .value { color: var(--accent-red); }
        .setup-item.tp .value { color: var(--accent-green); }
        
        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-card);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .data-table th,
        .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table th {
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
        }
        
        .data-table td {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
        }
        
        .data-table tr:hover {
            background: var(--bg-hover);
        }
        
        /* Analyzer */
        .analyzer-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
        }
        
        .pair-list {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1rem;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .pair-list-item {
            padding: 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        
        .pair-list-item:hover,
        .pair-list-item.selected {
            background: var(--bg-hover);
        }
        
        .analyzer-detail {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        /* Charts */
        .chart-container {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        /* Weights Editor */
        .weights-editor {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1.5rem;
        }
        
        .weight-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .weight-label {
            width: 150px;
            font-weight: 500;
        }
        
        .weight-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        
        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-blue);
            border-radius: 50%;
            cursor: pointer;
        }
        
        .weight-value {
            width: 60px;
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }
        
        .weights-total {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .weights-total.valid { border: 2px solid var(--accent-green); }
        .weights-total.invalid { border: 2px solid var(--accent-red); }
        
        /* Audit */
        .audit-section {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .audit-section h3 {
            margin-bottom: 1rem;
            color: var(--accent-blue);
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-badge.ok { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .status-badge.limited { background: rgba(245, 158, 11, 0.2); color: var(--accent-yellow); }
        .status-badge.error { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        
        /* Calendar */
        .event-card {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--border-color);
        }
        
        .event-card.high { border-left-color: var(--accent-red); }
        .event-card.medium { border-left-color: var(--accent-yellow); }
        .event-card.low { border-left-color: var(--accent-green); }
        
        /* News */
        .news-item {
            background: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .news-headline {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .news-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        
        /* Positioning */
        .position-bar {
            display: flex;
            height: 24px;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .position-long {
            background: var(--gradient-bull);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .position-short {
            background: var(--gradient-bear);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Backtest */
        .backtest-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .backtest-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .result-card {
            background: var(--bg-card);
            padding: 1.25rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        
        .result-card .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .result-card .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Refresh Timer */
        .refresh-timer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 1rem; }
            .header-stats { flex-wrap: wrap; justify-content: center; }
            .signals-grid { grid-template-columns: 1fr; }
            .analyzer-container { grid-template-columns: 1fr; }
            .main-content { padding: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">MEGA<span>FOREX</span> v8.1</div>
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="total-pairs">45</div>
                <div class="stat-label">Pairs</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="total-signals">-</div>
                <div class="stat-label">Signals</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="bullish-count" style="color: var(--accent-green);">-</div>
                <div class="stat-label">Bullish</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="bearish-count" style="color: var(--accent-red);">-</div>
                <div class="stat-label">Bearish</div>
            </div>
        </div>
        <div class="connection-status">
            <div class="status-dot" id="connection-dot"></div>
            <span id="connection-text">Connected</span>
        </div>
        <div class="refresh-timer">
            <span>Refresh in:</span>
            <span id="refresh-countdown">120s</span>
        </div>
    </header>
    
    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="overview">üìä Overview</button>
            <button class="nav-tab" data-tab="signals">üéØ Top Signals</button>
            <button class="nav-tab" data-tab="rates">üíπ Live Rates</button>
            <button class="nav-tab" data-tab="analyzer">üî¨ Pair Analyzer</button>
            <button class="nav-tab" data-tab="journal">üìî Journal</button>
            <button class="nav-tab" data-tab="performance">üìä Performance</button>
            <button class="nav-tab" data-tab="backtest">üìà Backtesting</button>
            <button class="nav-tab" data-tab="technical">üìâ Technical</button>
            <button class="nav-tab" data-tab="positioning">üë• Positioning</button>
            <button class="nav-tab" data-tab="news">üì∞ News</button>
            <button class="nav-tab" data-tab="calendar">üìÖ Calendar</button>
            <button class="nav-tab" data-tab="weights">‚öñÔ∏è Weights</button>
            <button class="nav-tab" data-tab="audit">üîç Audit</button>
            <button class="nav-tab" data-tab="api-status">‚öôÔ∏è API Status</button>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Overview Tab -->
        <div class="tab-content active" id="tab-overview">
            <div class="filters-bar">
                <div class="filter-group">
                    <span class="filter-label">Category:</span>
                    <select id="filter-category">
                        <option value="all">All</option>
                        <option value="major">Major</option>
                        <option value="cross">Cross</option>
                        <option value="exotic">Exotic</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Direction:</span>
                    <select id="filter-direction">
                        <option value="all">All</option>
                        <option value="long">Long Only</option>
                        <option value="short">Short Only</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Min Score:</span>
                    <select id="filter-score">
                        <option value="0">All</option>
                        <option value="50">50+</option>
                        <option value="60">60+</option>
                        <option value="70">70+</option>
                    </select>
                </div>
                <button onclick="loadSignals()">üîÑ Refresh</button>
            </div>
            <div class="signals-grid" id="signals-container">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading signals...
                </div>
            </div>
        </div>
        
        <!-- Top Signals Tab -->
        <div class="tab-content" id="tab-signals">
            <h2 style="margin-bottom: 1rem;">üéØ Top 10 Trading Signals</h2>
            <div id="top-signals-container">
                <div class="loading"><div class="spinner"></div>Loading...</div>
            </div>
        </div>
        
        <!-- Live Rates Tab -->
        <div class="tab-content" id="tab-rates">
            <h2 style="margin-bottom: 1rem;">üíπ Live Forex Rates</h2>
            <div class="filters-bar">
                <div class="filter-group">
                    <span class="filter-label">Category:</span>
                    <select id="rates-category">
                        <option value="all">All (45)</option>
                        <option value="major">Major (7)</option>
                        <option value="cross">Cross (23)</option>
                        <option value="exotic">Exotic (15)</option>
                    </select>
                </div>
            </div>
            <table class="data-table" id="rates-table">
                <thead>
                    <tr>
                        <th>Pair</th>
                        <th>Bid</th>
                        <th>Ask</th>
                        <th>Spread</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody id="rates-body">
                    <tr><td colspan="5" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pair Analyzer Tab -->
        <div class="tab-content" id="tab-analyzer">
            <h2 style="margin-bottom: 1rem;">üî¨ Pair Analyzer</h2>
            <div class="analyzer-container">
                <div class="pair-list" id="analyzer-pairs">
                    <!-- Pairs will be loaded here -->
                </div>
                <div class="analyzer-detail" id="analyzer-detail">
                    <p style="color: var(--text-secondary);">Select a pair to analyze</p>
                </div>
            </div>
        </div>
        
        <!-- Trade Journal Tab -->
        <div class="tab-content" id="tab-journal">
            <h2 style="margin-bottom: 1rem;">üìî Trade Journal</h2>
            
            <!-- Add Trade Form -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">‚ûï Add New Trade</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    <div>
                        <label style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.3rem;">Pair</label>
                        <select id="journal-pair" style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 0.3rem; color: var(--text-primary);">
                            <option value="EUR/USD">EUR/USD</option>
                            <option value="GBP/USD">GBP/USD</option>
                            <option value="USD/JPY">USD/JPY</option>
                            <option value="AUD/USD">AUD/USD</option>
                            <option value="USD/CAD">USD/CAD</option>
                            <option value="EUR/GBP">EUR/GBP</option>
                            <option value="EUR/JPY">EUR/JPY</option>
                            <option value="GBP/JPY">GBP/JPY</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.3rem;">Direction</label>
                        <select id="journal-direction" style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 0.3rem; color: var(--text-primary);">
                            <option value="LONG">LONG</option>
                            <option value="SHORT">SHORT</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.3rem;">Lot Size</label>
                        <input type="number" id="journal-lots" value="0.01" step="0.01" min="0.01" style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 0.3rem; color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.3rem;">Entry Price</label>
                        <input type="number" id="journal-entry" step="0.00001" style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 0.3rem; color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.3rem;">Stop Loss</label>
                        <input type="number" id="journal-sl" step="0.00001" style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 0.3rem; color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.3rem;">Take Profit</label>
                        <input type="number" id="journal-tp" step="0.00001" style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 0.3rem; color: var(--text-primary);">
                    </div>
                </div>
                <div style="margin-top: 1rem;">
                    <label style="display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.3rem;">Notes</label>
                    <textarea id="journal-notes" rows="2" style="width: 100%; padding: 0.5rem; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 0.3rem; color: var(--text-primary); resize: vertical;"></textarea>
                </div>
                <button onclick="addTrade()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: var(--accent); color: white; border: none; border-radius: 0.3rem; cursor: pointer; font-weight: 600;">Add Trade</button>
            </div>
            
            <!-- Open Trades -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">üîì Open Trades</h3>
                <div id="open-trades-list">
                    <p style="color: var(--text-muted);">Loading...</p>
                </div>
            </div>
            
            <!-- Trade History -->
            <div class="card">
                <h3 style="margin-bottom: 1rem;">üìú Trade History</h3>
                <div id="closed-trades-list">
                    <p style="color: var(--text-muted);">Loading...</p>
                </div>
            </div>
        </div>
        
        <!-- Performance Tab -->
        <div class="tab-content" id="tab-performance">
            <h2 style="margin-bottom: 1rem;">üìä Performance Analytics</h2>
            
            <!-- Overall Stats -->
            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-card">
                    <div class="stat-value" id="perf-total-trades">0</div>
                    <div class="stat-label">Total Trades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="perf-win-rate">0%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="perf-total-pips">0</div>
                    <div class="stat-label">Total Pips</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="perf-profit-factor">0</div>
                    <div class="stat-label">Profit Factor</div>
                </div>
            </div>
            
            <!-- Detailed Stats -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">üìà Detailed Statistics</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Wins / Losses</div>
                        <div style="font-size: 1.2rem; font-weight: 600;"><span id="perf-wins" style="color: #00ff88;">0</span> / <span id="perf-losses" style="color: #ff6666;">0</span></div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Best Trade</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: #00ff88;" id="perf-best">0 pips</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Worst Trade</div>
                        <div style="font-size: 1.2rem; font-weight: 600; color: #ff6666;" id="perf-worst">0 pips</div>
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">Avg Win / Avg Loss</div>
                        <div style="font-size: 1.2rem; font-weight: 600;"><span id="perf-avg-win" style="color: #00ff88;">0</span> / <span id="perf-avg-loss" style="color: #ff6666;">0</span> pips</div>
                    </div>
                </div>
            </div>
            
            <!-- Performance by Pair -->
            <div class="card">
                <h3 style="margin-bottom: 1rem;">üí± Performance by Pair</h3>
                <div id="perf-by-pair">
                    <p style="color: var(--text-muted);">No trade data yet</p>
                </div>
            </div>
        </div>
        
        <!-- Backtesting Tab -->
        <div class="tab-content" id="tab-backtest">
            <h2 style="margin-bottom: 1rem;">üìà Strategy Backtesting</h2>
            <div class="backtest-config">
                <div class="filter-group">
                    <span class="filter-label">Pair:</span>
                    <select id="backtest-pair">
                        <option value="EUR/USD">EUR/USD</option>
                        <option value="GBP/USD">GBP/USD</option>
                        <option value="USD/JPY">USD/JPY</option>
                        <option value="AUD/USD">AUD/USD</option>
                        <option value="EUR/GBP">EUR/GBP</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Period:</span>
                    <select id="backtest-days">
                        <option value="14">14 Days</option>
                        <option value="30" selected>30 Days</option>
                        <option value="60">60 Days</option>
                        <option value="90">90 Days</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Min Score:</span>
                    <select id="backtest-score">
                        <option value="50">50+</option>
                        <option value="60" selected>60+</option>
                        <option value="70">70+</option>
                        <option value="80">80+</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Min Stars:</span>
                    <select id="backtest-stars">
                        <option value="2">2+</option>
                        <option value="3" selected>3+</option>
                        <option value="4">4+</option>
                    </select>
                </div>
                <button onclick="runBacktest()">‚ñ∂Ô∏è Run Backtest</button>
            </div>
            <div id="backtest-results">
                <p style="color: var(--text-secondary); text-align: center;">Configure parameters and click Run Backtest</p>
            </div>
        </div>
        
        <!-- Technical Tab -->
        <div class="tab-content" id="tab-technical">
            <h2 style="margin-bottom: 1rem;">üìâ Technical Indicators</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Pair</th>
                        <th>RSI</th>
                        <th>MACD</th>
                        <th>ADX</th>
                        <th>ATR</th>
                        <th>BB %</th>
                        <th>EMA Signal</th>
                    </tr>
                </thead>
                <tbody id="technical-body">
                    <tr><td colspan="7" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Positioning Tab -->
        <div class="tab-content" id="tab-positioning">
            <h2 style="margin-bottom: 1rem;">üë• Retail Positioning</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Contrarian indicator: When retail is heavily long, consider selling. When heavily short, consider buying.
            </p>
            <div id="positioning-container">
                <div class="loading"><div class="spinner"></div>Loading...</div>
            </div>
        </div>
        
        <!-- News Tab -->
        <div class="tab-content" id="tab-news">
            <h2 style="margin-bottom: 1rem;">üì∞ Forex News & Sentiment</h2>
            <div id="news-container">
                <div class="loading"><div class="spinner"></div>Loading...</div>
            </div>
        </div>
        
        <!-- Calendar Tab -->
        <div class="tab-content" id="tab-calendar">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2>üìÖ Economic Calendar</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="filter-group">
                        <span class="filter-label">Currency:</span>
                        <select id="calendar-currency">
                            <option value="all">All Currencies</option>
                            <option value="USD">üá∫üá∏ USD</option>
                            <option value="EUR">üá™üá∫ EUR</option>
                            <option value="GBP">üá¨üáß GBP</option>
                            <option value="JPY">üáØüáµ JPY</option>
                            <option value="AUD">üá¶üá∫ AUD</option>
                            <option value="CAD">üá®üá¶ CAD</option>
                            <option value="NZD">üá≥üáø NZD</option>
                            <option value="CHF">üá®üá≠ CHF</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Impact:</span>
                        <select id="calendar-impact">
                            <option value="all">All</option>
                            <option value="high">üî¥ High Only</option>
                            <option value="medium">üü° Medium+</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- Calendar Legend -->
            <div style="display: flex; gap: 2rem; margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-card); border-radius: 0.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="width: 12px; height: 12px; border-radius: 50%; background: #ef4444;"></span>
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">High Impact</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="width: 12px; height: 12px; border-radius: 50%; background: #f59e0b;"></span>
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">Medium Impact</span>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="width: 12px; height: 12px; border-radius: 50%; background: #10b981;"></span>
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">Low Impact</span>
                </div>
            </div>
            
            <!-- Calendar Table -->
            <div id="calendar-container">
                <div class="loading"><div class="spinner"></div>Loading economic events...</div>
            </div>
        </div>
        
        <!-- Weights Editor Tab -->
        <div class="tab-content" id="tab-weights">
            <h2 style="margin-bottom: 1rem;">‚öñÔ∏è Factor Weights Editor</h2>
            <div class="weights-editor" id="weights-editor">
                <div class="loading"><div class="spinner"></div>Loading weights...</div>
            </div>
        </div>
        
        <!-- Audit Tab -->
        <div class="tab-content" id="tab-audit">
            <h2 style="margin-bottom: 1rem;">üîç System Audit</h2>
            <button onclick="runAudit()" style="margin-bottom: 1rem;">‚ñ∂Ô∏è Run Audit</button>
            <div id="audit-container">
                <p style="color: var(--text-secondary);">Click Run Audit to check system health</p>
            </div>
        </div>
        
        <!-- API Status Tab -->
        <div class="tab-content" id="tab-api-status">
            <h2 style="margin-bottom: 1rem;">‚öôÔ∏è API Connection Status</h2>
            <div id="api-status-container">
                <div class="loading"><div class="spinner"></div>Loading...</div>
            </div>
        </div>
    </main>

    <script>
        // Configuration - Dynamic API_BASE for Render/Local
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:5000' 
            : window.location.origin;
        let signalsData = [];
        let refreshInterval;
        let countdown = 120;
        
        // All 45 Forex Pairs for Pair Analyzer
        const ALL_PAIRS = [
            // Majors (7)
            'EUR/USD', 'GBP/USD', 'USD/JPY', 'USD/CHF', 'AUD/USD', 'USD/CAD', 'NZD/USD',
            // Crosses (21)
            'EUR/GBP', 'EUR/JPY', 'EUR/CHF', 'EUR/AUD', 'EUR/CAD', 'EUR/NZD',
            'GBP/JPY', 'GBP/CHF', 'GBP/AUD', 'GBP/CAD', 'GBP/NZD',
            'AUD/JPY', 'AUD/NZD', 'AUD/CAD', 'AUD/CHF',
            'NZD/JPY', 'NZD/CAD', 'NZD/CHF',
            'CAD/JPY', 'CAD/CHF', 'CHF/JPY',
            // Exotics (17)
            'USD/SGD', 'USD/HKD', 'USD/MXN', 'USD/ZAR', 'USD/TRY', 
            'USD/NOK', 'USD/SEK', 'USD/DKK', 'USD/PLN',
            'EUR/TRY', 'EUR/PLN', 'EUR/NOK', 'EUR/SEK', 'EUR/HUF', 'EUR/CZK',
            'SGD/JPY', 'HKD/JPY'
        ];
        
        // Tab Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
                
                // Load data for specific tabs
                const tabName = tab.dataset.tab;
                if (tabName === 'rates') loadRates();
                else if (tabName === 'analyzer') loadAnalyzerPairs();
                else if (tabName === 'technical') loadTechnical();
                else if (tabName === 'positioning') loadPositioning();
                else if (tabName === 'news') loadNews();
                else if (tabName === 'calendar') loadCalendar();
                else if (tabName === 'weights') loadWeights();
                else if (tabName === 'journal') loadJournal();
                else if (tabName === 'performance') loadPerformance();
                else if (tabName === 'api-status') loadApiStatus();
            });
        });
        
        // Load Signals - Optimized for Render free tier with timeout and retry
        async function loadSignals() {
            const container = document.getElementById('signals-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Connecting to server...</div>';
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 sec timeout
            
            try {
                // First try fast /top-signals endpoint
                let response = await fetch(`${API_BASE}/top-signals?limit=45`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                let data = await response.json();
                
                if (data.success && data.signals && data.signals.length > 0) {
                    signalsData = data.signals;
                    renderSignals();
                    updateStats();
                    document.getElementById('connection-dot').style.background = 'var(--accent-green)';
                    document.getElementById('connection-text').textContent = 'Connected';
                    
                    // If still loading real data, show indicator and retry
                    if (data.loading) {
                        document.getElementById('connection-text').textContent = 'Loading...';
                        setTimeout(() => {
                            fetch(`${API_BASE}/signals`).then(r => r.json()).then(fullData => {
                                if (fullData.success && fullData.signals) {
                                    signalsData = fullData.signals;
                                    renderSignals();
                                    updateStats();
                                    document.getElementById('connection-text').textContent = 'Connected';
                                }
                            }).catch(() => {});
                        }, 3000);
                    }
                    return;
                }
                
                // Fallback to regular /signals
                response = await fetch(`${API_BASE}/signals`);
                data = await response.json();
                
                if (data.success && data.signals) {
                    signalsData = data.signals;
                    renderSignals();
                    updateStats();
                    document.getElementById('connection-dot').style.background = 'var(--accent-green)';
                    document.getElementById('connection-text').textContent = 'Connected';
                }
            } catch (error) {
                clearTimeout(timeoutId);
                
                if (error.name === 'AbortError') {
                    // Timeout - server is waking up, show friendly message and retry
                    container.innerHTML = `
                        <div class="loading" style="text-align: center;">
                            <div class="spinner"></div>
                            <div style="margin-top: 10px;">Server is waking up...</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
                                Free hosting spins down after inactivity. Please wait ~30 seconds.
                            </div>
                            <button onclick="loadSignals()" style="margin-top: 15px; padding: 8px 20px; background: var(--accent-blue); border: none; border-radius: 5px; color: white; cursor: pointer;">
                                Retry Now
                            </button>
                        </div>
                    `;
                    document.getElementById('connection-dot').style.background = 'var(--accent-yellow)';
                    document.getElementById('connection-text').textContent = 'Waking up...';
                    
                    // Auto-retry after 5 seconds
                    setTimeout(loadSignals, 5000);
                } else {
                    console.error('Error loading signals:', error);
                    container.innerHTML = `
                        <div class="loading" style="color: var(--accent-red); text-align: center;">
                            <div>Connection failed</div>
                            <button onclick="loadSignals()" style="margin-top: 15px; padding: 8px 20px; background: var(--accent-blue); border: none; border-radius: 5px; color: white; cursor: pointer;">
                                Retry
                            </button>
                        </div>
                    `;
                    document.getElementById('connection-dot').style.background = 'var(--accent-red)';
                    document.getElementById('connection-text').textContent = 'Disconnected';
                }
            }
        }
        
        // Render Signals
        function renderSignals() {
            const container = document.getElementById('signals-container');
            const category = document.getElementById('filter-category').value;
            const direction = document.getElementById('filter-direction').value;
            const minScore = parseInt(document.getElementById('filter-score').value);
            
            let filtered = signalsData.filter(s => {
                if (category !== 'all' && s.category.toLowerCase() !== category) return false;
                if (direction !== 'all' && s.direction.toLowerCase() !== direction) return false;
                if (s.composite_score < minScore) return false;
                return true;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="loading">No signals match your filters</div>';
                return;
            }
            
            container.innerHTML = filtered.map(s => createSignalCard(s)).join('');
        }
        
        // Create Signal Card
        function createSignalCard(signal) {
            const scoreClass = signal.composite_score >= 60 ? 'bullish' : signal.composite_score <= 40 ? 'bearish' : 'neutral';
            const dirClass = signal.direction.toLowerCase();
            const stars = '‚òÖ'.repeat(signal.stars) + '‚òÜ'.repeat(5 - signal.stars);
            
            const factorGrid = Object.entries(signal.factor_grid || {}).map(([key, value]) => 
                `<div class="factor-item ${value}">${key}</div>`
            ).join('');
            
            const stats = signal.statistics || {};
            
            return `
                <div class="signal-card" onclick="analyzeSignal('${signal.pair}')">
                    <div class="card-header">
                        <div class="pair-info">
                            <span class="pair-name">${signal.pair}</span>
                            <span class="category-badge ${signal.category.toLowerCase()}">${signal.category}</span>
                        </div>
                        <div class="composite-score">
                            <div class="score-value ${scoreClass}">${signal.composite_score}</div>
                            <div class="stars">${stars}</div>
                        </div>
                    </div>
                    
                    <span class="direction-badge ${dirClass}">${signal.direction}</span>
                    
                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="value">${(stats.win_rate || 50).toFixed(0)}%</div>
                            <div class="label">WIN%</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${(stats.expectancy || 50).toFixed(0)}%</div>
                            <div class="label">EXP%</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${stats.hold_days || 3}D</div>
                            <div class="label">HOLD</div>
                        </div>
                        <div class="stat-box">
                            <div class="value">${(stats.profit_factor || 1).toFixed(1)}</div>
                            <div class="label">PF</div>
                        </div>
                    </div>
                    
                    <div class="factor-grid">${factorGrid}</div>
                    
                    <div class="trade-setup">
                        <div class="setup-title">TRADE SETUP ${signal.trade_setup?.trade_quality ? `<span style="color: ${signal.trade_setup.trade_quality === 'A+' ? '#00ff88' : signal.trade_setup.trade_quality === 'A' ? '#00cc66' : signal.trade_setup.trade_quality === 'B' ? '#ffaa00' : '#ff6666'}; margin-left: 0.5rem;">[${signal.trade_setup.trade_quality}]</span>` : ''}</div>
                        <div class="setup-grid">
                            <div class="setup-item entry">
                                <div class="label">ENTRY</div>
                                <div class="value">${signal.trade_setup?.entry?.toFixed(5) || 'N/A'}</div>
                            </div>
                            <div class="setup-item sl">
                                <div class="label">SL (${signal.trade_setup?.sl_pips?.toFixed(0) || 0}p)</div>
                                <div class="value">${signal.trade_setup?.sl?.toFixed(5) || 'N/A'}</div>
                            </div>
                            <div class="setup-item tp">
                                <div class="label">TP1 (${signal.trade_setup?.tp1_pips?.toFixed(0) || 0}p)</div>
                                <div class="value">${signal.trade_setup?.tp1?.toFixed(5) || 'N/A'}</div>
                            </div>
                            <div class="setup-item tp">
                                <div class="label">R:R</div>
                                <div class="value">1:${signal.trade_setup?.risk_reward_1?.toFixed(1) || signal.trade_setup?.risk_reward?.toFixed(1) || '1.5'}</div>
                            </div>
                        </div>
                        ${signal.trade_setup?.market_context ? `
                        <div style="margin-top: 0.5rem; font-size: 0.7rem; color: var(--text-muted); display: flex; gap: 0.5rem; justify-content: center;">
                            <span>Vol: ${signal.trade_setup.market_context.volatility}</span>
                            <span>|</span>
                            <span>Trend: ${signal.trade_setup.market_context.trend}</span>
                            <span>|</span>
                            <span>Conf: ${signal.trade_setup.market_context.confidence}</span>
                        </div>
                        ` : ''}
                        ${signal.patterns && signal.patterns.patterns && signal.patterns.patterns.length > 0 ? `
                        <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);">
                            <div style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.3rem;">üïØÔ∏è PATTERNS DETECTED</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.3rem; justify-content: center;">
                                ${signal.patterns.patterns.slice(0, 3).map(p => `
                                    <span style="font-size: 0.65rem; padding: 0.2rem 0.4rem; border-radius: 0.2rem; background: ${p.signal === 'BULLISH' ? 'rgba(0,255,136,0.2)' : p.signal === 'BEARISH' ? 'rgba(255,102,102,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${p.signal === 'BULLISH' ? '#00ff88' : p.signal === 'BEARISH' ? '#ff6666' : '#999'};">${p.name.replace('_', ' ')}</span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // Update Stats
        function updateStats() {
            document.getElementById('total-signals').textContent = signalsData.length;
            document.getElementById('bullish-count').textContent = signalsData.filter(s => s.direction === 'LONG').length;
            document.getElementById('bearish-count').textContent = signalsData.filter(s => s.direction === 'SHORT').length;
        }
        
        // Load Rates
        async function loadRates() {
            try {
                const response = await fetch(`${API_BASE}/rates`);
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('rates-body');
                    const category = document.getElementById('rates-category').value;
                    
                    let rates = Object.entries(data.rates);
                    
                    tbody.innerHTML = rates.map(([pair, rate]) => `
                        <tr>
                            <td style="font-weight: 600;">${pair}</td>
                            <td>${rate.bid?.toFixed(5) || 'N/A'}</td>
                            <td>${rate.ask?.toFixed(5) || 'N/A'}</td>
                            <td>${((rate.ask - rate.bid) * 10000).toFixed(1)} pips</td>
                            <td><span class="status-badge ${rate.source === 'polygon' ? 'ok' : rate.source === 'exchangerate' ? 'limited' : 'error'}">${rate.source}</span></td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading rates:', error);
            }
        }
        
        // Load Analyzer Pairs
        function loadAnalyzerPairs() {
            const container = document.getElementById('analyzer-pairs');
            
            // Show ALL 45 pairs, with score from signalsData if available
            container.innerHTML = ALL_PAIRS.map(pair => {
                const signal = signalsData.find(s => s.pair === pair);
                const score = signal ? signal.composite_score : '--';
                const direction = signal ? signal.direction : 'NEUTRAL';
                const color = direction === 'LONG' ? 'var(--accent-green)' : direction === 'SHORT' ? 'var(--accent-red)' : 'var(--text-secondary)';
                
                return `
                    <div class="pair-list-item" onclick="analyzeSignal('${pair}')">
                        <span>${pair}</span>
                        <span style="color: ${color}">${score}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Analyze Signal
        async function analyzeSignal(pair) {
            const detail = document.getElementById('analyzer-detail');
            detail.innerHTML = '<div class="loading"><div class="spinner"></div>Loading analysis...</div>';
            
            // Switch to analyzer tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector('[data-tab="analyzer"]').classList.add('active');
            document.getElementById('tab-analyzer').classList.add('active');
            
            try {
                const response = await fetch(`${API_BASE}/signal/${pair.replace('/', '_')}`);
                const signal = await response.json();
                
                if (signal.success) {
                    detail.innerHTML = `
                        <h3 style="margin-bottom: 1rem;">${signal.pair} Analysis</h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="result-card">
                                <div class="value ${signal.composite_score >= 60 ? '' : 'style="color: var(--accent-red)"'}">${signal.composite_score}</div>
                                <div class="label">Composite Score</div>
                            </div>
                            <div class="result-card">
                                <div class="value" style="color: ${signal.direction === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)'}">${signal.direction}</div>
                                <div class="label">Direction</div>
                            </div>
                        </div>
                        
                        <h4 style="margin-bottom: 0.5rem;">9-Factor Breakdown (REAL DATA)</h4>
                        <table class="data-table" style="margin-bottom: 1.5rem;">
                            <thead>
                                <tr>
                                    <th>Factor</th>
                                    <th>Score</th>
                                    <th>Signal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(signal.factors || {}).map(([name, data]) => `
                                    <tr>
                                        <td style="text-transform: capitalize;">${name}</td>
                                        <td>${data.score?.toFixed(1) || 'N/A'}</td>
                                        <td><span class="status-badge ${data.signal === 'BULLISH' ? 'ok' : data.signal === 'BEARISH' ? 'error' : 'limited'}">${data.signal}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <h4 style="margin-bottom: 0.5rem;">Technical Indicators</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                            <div class="result-card">
                                <div class="value">${signal.technical?.rsi?.toFixed(1) || 'N/A'}</div>
                                <div class="label">RSI</div>
                            </div>
                            <div class="result-card">
                                <div class="value">${signal.technical?.adx?.toFixed(1) || 'N/A'}</div>
                                <div class="label">ADX</div>
                            </div>
                            <div class="result-card">
                                <div class="value">${signal.technical?.atr?.toFixed(5) || 'N/A'}</div>
                                <div class="label">ATR</div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 1rem 0 0.5rem;">Smart Trade Setup ${signal.trade_setup?.trade_quality ? `<span style="color: ${signal.trade_setup.trade_quality === 'A+' ? '#00ff88' : signal.trade_setup.trade_quality === 'A' ? '#00cc66' : signal.trade_setup.trade_quality === 'B' ? '#ffaa00' : '#ff6666'}; font-size: 0.9rem;">[Grade: ${signal.trade_setup.trade_quality}]</span>` : ''}</h4>
                        
                        ${signal.trade_setup?.market_context ? `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem; display: flex; gap: 1.5rem; justify-content: center; flex-wrap: wrap;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">VOLATILITY</div>
                                <div style="font-weight: 600; color: ${signal.trade_setup.market_context.volatility === 'HIGH' ? '#ff6666' : signal.trade_setup.market_context.volatility === 'LOW' ? '#66aaff' : '#00cc66'};">${signal.trade_setup.market_context.volatility}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">TREND</div>
                                <div style="font-weight: 600; color: ${signal.trade_setup.market_context.trend === 'STRONG' ? '#00ff88' : signal.trade_setup.market_context.trend === 'WEAK' ? '#ffaa00' : '#00cc66'};">${signal.trade_setup.market_context.trend}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">CONFIDENCE</div>
                                <div style="font-weight: 600; color: ${signal.trade_setup.market_context.confidence === 'HIGH' ? '#00ff88' : signal.trade_setup.market_context.confidence === 'LOW' ? '#ff6666' : '#ffaa00'};">${signal.trade_setup.market_context.confidence}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">SL MULT</div>
                                <div style="font-weight: 600;">${signal.trade_setup.sl_multiplier || '1.8'}x</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: var(--text-muted);">TP MULT</div>
                                <div style="font-weight: 600;">${signal.trade_setup.tp1_multiplier || '2.5'}x</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="trade-setup">
                            <div class="setup-grid" style="grid-template-columns: repeat(5, 1fr);">
                                <div class="setup-item entry">
                                    <div class="label">ENTRY</div>
                                    <div class="value">${signal.trade_setup?.entry?.toFixed(5) || 'N/A'}</div>
                                </div>
                                <div class="setup-item sl">
                                    <div class="label">SL (${signal.trade_setup?.sl_pips?.toFixed(0) || 0}p)</div>
                                    <div class="value">${signal.trade_setup?.sl?.toFixed(5) || 'N/A'}</div>
                                </div>
                                <div class="setup-item tp">
                                    <div class="label">TP1 (${signal.trade_setup?.tp1_pips?.toFixed(0) || 0}p)</div>
                                    <div class="value">${signal.trade_setup?.tp1?.toFixed(5) || 'N/A'}</div>
                                </div>
                                <div class="setup-item tp">
                                    <div class="label">TP2 (${signal.trade_setup?.tp2_pips?.toFixed(0) || 0}p)</div>
                                    <div class="value">${signal.trade_setup?.tp2?.toFixed(5) || 'N/A'}</div>
                                </div>
                                <div class="setup-item" style="background: var(--bg-secondary);">
                                    <div class="label">R:R</div>
                                    <div class="value" style="color: ${(signal.trade_setup?.risk_reward_1 || 1.5) >= 2 ? '#00ff88' : (signal.trade_setup?.risk_reward_1 || 1.5) >= 1.5 ? '#00cc66' : '#ffaa00'};">1:${signal.trade_setup?.risk_reward_1?.toFixed(1) || '1.5'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- TradingView Chart -->
                        <h4 style="margin: 1.5rem 0 0.5rem;">Price Chart</h4>
                        <div style="height: 400px; background: var(--bg-secondary); border-radius: 0.5rem; overflow: hidden;">
                            <iframe 
                                src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview&symbol=${signal.pair.replace('/', '')}&interval=60&theme=dark&style=1&locale=en&toolbar_bg=%231a1f2e&enable_publishing=false&hide_top_toolbar=false&hide_legend=false&save_image=false&container_id=tradingview_chart"
                                style="width: 100%; height: 100%; border: none;">
                            </iframe>
                        </div>
                    `;
                }
            } catch (error) {
                detail.innerHTML = '<p style="color: var(--accent-red);">Error loading analysis</p>';
            }
        }
        
        // Load Technical
        async function loadTechnical() {
            try {
                const tbody = document.getElementById('technical-body');
                tbody.innerHTML = signalsData.slice(0, 20).map(s => `
                    <tr>
                        <td style="font-weight: 600;">${s.pair}</td>
                        <td style="color: ${s.technical?.rsi < 30 ? 'var(--accent-green)' : s.technical?.rsi > 70 ? 'var(--accent-red)' : 'inherit'}">${s.technical?.rsi?.toFixed(1) || 'N/A'}</td>
                        <td style="color: ${s.technical?.macd?.histogram > 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${s.technical?.macd?.histogram?.toFixed(5) || 'N/A'}</td>
                        <td>${s.technical?.adx?.toFixed(1) || 'N/A'}</td>
                        <td>${s.technical?.atr?.toFixed(5) || 'N/A'}</td>
                        <td>${s.technical?.bollinger?.percent_b?.toFixed(1) || 'N/A'}%</td>
                        <td><span class="status-badge ${s.technical?.ema_signal === 'BULLISH' ? 'ok' : s.technical?.ema_signal === 'BEARISH' ? 'error' : 'limited'}">${s.technical?.ema_signal || 'N/A'}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading technical:', error);
            }
        }
        
        // Load Positioning
        async function loadPositioning() {
            try {
                const response = await fetch(`${API_BASE}/positioning`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('positioning-container');
                    
                    // Show data source indicator
                    const sourceLabel = data.source === 'IG_MARKETS_REAL' 
                        ? '<span style="color: var(--accent-green); font-weight: 600;">üìä REAL DATA from IG Markets</span>'
                        : '<span style="color: var(--accent-yellow); font-weight: 600;">‚ö†Ô∏è Configure IG API for real positioning data</span>';
                    
                    let html = `<div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem; text-align: center;">${sourceLabel}</div>`;
                    
                    if (data.source === 'NOT_CONFIGURED') {
                        html += `<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <p>Add IG credentials to .env file for REAL positioning data:</p>
                            <code style="display: block; margin-top: 1rem; padding: 1rem; background: var(--bg-card); border-radius: 0.5rem; text-align: left;">
                            IG_API_KEY=your_api_key<br>
                            IG_USERNAME=your_username<br>
                            IG_PASSWORD=your_password<br>
                            IG_ACC_TYPE=DEMO
                            </code>
                        </div>`;
                    } else {
                        html += data.data.map(p => `
                            <div style="background: var(--bg-card); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 600;">${p.pair}</span>
                                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                                        ${p.source === 'IG_REAL' ? '<span style="font-size: 0.7rem; color: var(--accent-green);">‚óè IG</span>' : ''}
                                        <span class="status-badge ${p.contrarian_signal === 'LONG' ? 'ok' : p.contrarian_signal === 'SHORT' ? 'error' : 'limited'}">
                                            Contrarian: ${p.contrarian_signal}
                                        </span>
                                    </div>
                                </div>
                                <div class="position-bar">
                                    <div class="position-long" style="width: ${p.long_percentage}%">${p.long_percentage}% Long</div>
                                    <div class="position-short" style="width: ${p.short_percentage}%">${p.short_percentage}% Short</div>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading positioning:', error);
                document.getElementById('positioning-container').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--accent-red);">
                        <p>Failed to load positioning data. Check backend connection.</p>
                    </div>
                `;
            }
        }
        
        // Load News
        async function loadNews() {
            try {
                const response = await fetch(`${API_BASE}/news`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('news-container');
                    
                    if (data.articles && data.articles.length > 0) {
                        container.innerHTML = data.articles.map(article => `
                            <div class="news-item">
                                <div class="news-headline">${article.headline}</div>
                                <div class="news-meta">
                                    ${article.source} | ${new Date(article.datetime * 1000).toLocaleString()}
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p style="color: var(--text-secondary);">No news available. Make sure Finnhub API key is configured.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading news:', error);
            }
        }
        
        // Load Calendar
        async function loadCalendar() {
            try {
                const response = await fetch(`${API_BASE}/calendar`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('calendar-container');
                    const impactFilter = document.getElementById('calendar-impact').value;
                    const currencyFilter = document.getElementById('calendar-currency').value;
                    
                    let events = data.events || [];
                    
                    // Filter by impact
                    if (impactFilter !== 'all') {
                        events = events.filter(e => {
                            if (impactFilter === 'high') return e.impact === 'high';
                            return e.impact === 'high' || e.impact === 'medium';
                        });
                    }
                    
                    // Filter by currency
                    if (currencyFilter !== 'all') {
                        const currencyMap = {
                            'USD': ['US', 'USA'],
                            'EUR': ['EU', 'DE', 'FR', 'IT', 'ES'],
                            'GBP': ['UK', 'GB'],
                            'JPY': ['JP'],
                            'AUD': ['AU'],
                            'CAD': ['CA'],
                            'NZD': ['NZ'],
                            'CHF': ['CH']
                        };
                        const codes = currencyMap[currencyFilter] || [currencyFilter];
                        events = events.filter(e => codes.some(c => e.country.toUpperCase().includes(c)));
                    }
                    
                    if (events.length > 0) {
                        const getFlag = (country) => {
                            const flags = {
                                'US': 'üá∫üá∏', 'USA': 'üá∫üá∏',
                                'EU': 'üá™üá∫', 'DE': 'üá©üá™', 'FR': 'üá´üá∑', 'IT': 'üáÆüáπ', 'ES': 'üá™üá∏',
                                'UK': 'üá¨üáß', 'GB': 'üá¨üáß',
                                'JP': 'üáØüáµ',
                                'AU': 'üá¶üá∫',
                                'CA': 'üá®üá¶',
                                'NZ': 'üá≥üáø',
                                'CH': 'üá®üá≠',
                                'CN': 'üá®üá≥'
                            };
                            return flags[country.toUpperCase()] || 'üåê';
                        };
                        
                        const getImpactDots = (impact) => {
                            if (impact === 'high') return '<span style="color: #ef4444;">‚óè‚óè‚óè</span>';
                            if (impact === 'medium') return '<span style="color: #f59e0b;">‚óè‚óè</span><span style="color: #374151;">‚óè</span>';
                            return '<span style="color: #10b981;">‚óè</span><span style="color: #374151;">‚óè‚óè</span>';
                        };
                        
                        const getCountdown = (timeStr) => {
                            if (!timeStr) return '<span style="color: var(--text-muted);">--:--</span>';
                            
                            const eventDate = new Date(timeStr);
                            const now = new Date();
                            const diff = eventDate - now;
                            
                            if (diff < 0) return '<span style="color: var(--accent-green);">Released</span>';
                            
                            const hours = Math.floor(diff / (1000 * 60 * 60));
                            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            
                            if (hours > 24) {
                                const days = Math.floor(hours / 24);
                                return `<span style="color: var(--text-secondary);">${days}d ${hours % 24}h</span>`;
                            }
                            if (hours > 0) {
                                return `<span style="color: var(--accent-yellow);">${hours}h ${minutes}m</span>`;
                            }
                            return `<span style="color: var(--accent-red);">${minutes}m</span>`;
                        };
                        
                        const formatTime = (timeStr) => {
                            if (!timeStr) return '--:--';
                            const date = new Date(timeStr);
                            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                        };
                        
                        const formatDate = (timeStr) => {
                            if (!timeStr) return '--';
                            const date = new Date(timeStr);
                            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                        };
                        
                        container.innerHTML = `
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">Time</th>
                                        <th style="width: 80px;">Currency</th>
                                        <th style="width: 60px;">Impact</th>
                                        <th>Event</th>
                                        <th style="width: 90px;">Forecast</th>
                                        <th style="width: 90px;">Previous</th>
                                        <th style="width: 90px;">Actual</th>
                                        <th style="width: 100px;">Countdown</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${events.map(e => `
                                        <tr style="border-left: 3px solid ${e.impact === 'high' ? '#ef4444' : e.impact === 'medium' ? '#f59e0b' : '#10b981'};">
                                            <td>
                                                <div style="font-weight: 600;">${formatTime(e.time)}</div>
                                                <div style="font-size: 0.7rem; color: var(--text-muted);">${formatDate(e.time)}</div>
                                            </td>
                                            <td>
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <span style="font-size: 1.25rem;">${getFlag(e.country)}</span>
                                                    <span style="font-weight: 500;">${e.country}</span>
                                                </div>
                                            </td>
                                            <td style="text-align: center;">${getImpactDots(e.impact)}</td>
                                            <td style="font-weight: 500;">${e.event}</td>
                                            <td style="text-align: center; color: var(--text-secondary);">${e.estimate || '-'}</td>
                                            <td style="text-align: center; color: var(--text-secondary);">${e.previous || '-'}</td>
                                            <td style="text-align: center; font-weight: 600; color: ${e.actual ? (parseFloat(e.actual) > parseFloat(e.estimate) ? 'var(--accent-green)' : 'var(--accent-red)') : 'var(--text-muted)'};">
                                                ${e.actual || 'Pending'}
                                            </td>
                                            <td style="text-align: center; font-family: 'JetBrains Mono', monospace;">
                                                ${getCountdown(e.time)}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    } else {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üìÖ</div>
                                <p>No events match your filters.</p>
                                <p style="font-size: 0.875rem; margin-top: 0.5rem;">Try selecting "All" for Impact and Currency filters.</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading calendar:', error);
                document.getElementById('calendar-container').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--accent-red);">
                        <p>Failed to load calendar. Check backend connection.</p>
                    </div>
                `;
            }
        }
        
        // Calendar filter listeners
        document.getElementById('calendar-impact').addEventListener('change', loadCalendar);
        document.getElementById('calendar-currency').addEventListener('change', loadCalendar);
        
        // Load Weights
        async function loadWeights() {
            try {
                const response = await fetch(`${API_BASE}/weights`);
                const data = await response.json();
                
                if (data.success) {
                    const editor = document.getElementById('weights-editor');
                    const weights = data.weights;
                    
                    editor.innerHTML = `
                        ${Object.entries(weights).map(([name, value]) => `
                            <div class="weight-row">
                                <span class="weight-label">${name.charAt(0).toUpperCase() + name.slice(1)}</span>
                                <input type="range" class="weight-slider" id="weight-${name}" min="0" max="30" value="${value}" 
                                    oninput="updateWeightValue('${name}', this.value)">
                                <span class="weight-value" id="value-${name}">${value}%</span>
                            </div>
                        `).join('')}
                        
                        <div class="weights-total" id="weights-total">
                            <span>Total:</span>
                            <span id="total-weight">${Object.values(weights).reduce((a, b) => a + b, 0)}%</span>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button onclick="saveWeights()">üíæ Save Weights</button>
                            <button class="secondary" onclick="resetWeights()">üîÑ Reset to Defaults</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading weights:', error);
            }
        }
        
        function updateWeightValue(name, value) {
            document.getElementById(`value-${name}`).textContent = `${value}%`;
            
            // Calculate total
            const sliders = document.querySelectorAll('.weight-slider');
            let total = 0;
            sliders.forEach(s => total += parseInt(s.value));
            
            document.getElementById('total-weight').textContent = `${total}%`;
            
            const totalDiv = document.getElementById('weights-total');
            totalDiv.className = 'weights-total ' + (total === 100 ? 'valid' : 'invalid');
        }
        
        async function saveWeights() {
            const weights = {};
            document.querySelectorAll('.weight-slider').forEach(slider => {
                const name = slider.id.replace('weight-', '');
                weights[name] = parseInt(slider.value);
            });
            
            const total = Object.values(weights).reduce((a, b) => a + b, 0);
            if (total !== 100) {
                alert('Weights must sum to 100%');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/weights`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(weights)
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Weights saved successfully!');
                    loadSignals();
                }
            } catch (error) {
                alert('Error saving weights');
            }
        }
        
        async function resetWeights() {
            try {
                const response = await fetch(`${API_BASE}/weights/reset`);
                const data = await response.json();
                if (data.success) {
                    loadWeights();
                    loadSignals();
                }
            } catch (error) {
                alert('Error resetting weights');
            }
        }
        
        // Run Backtest
        async function runBacktest() {
            const container = document.getElementById('backtest-results');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Running backtest...</div>';
            
            const pair = document.getElementById('backtest-pair').value;
            const days = document.getElementById('backtest-days').value;
            const minScore = document.getElementById('backtest-score').value;
            const minStars = document.getElementById('backtest-stars').value;
            
            try {
                const response = await fetch(`${API_BASE}/backtest?pair=${encodeURIComponent(pair)}&days=${days}&min_score=${minScore}&min_stars=${minStars}`);
                const data = await response.json();
                
                if (data.success) {
                    container.innerHTML = `
                        <div class="backtest-results">
                            <div class="result-card">
                                <div class="value" style="color: ${data.total_pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
                                    $${data.total_pnl?.toFixed(2) || 0}
                                </div>
                                <div class="label">Total P&L</div>
                            </div>
                            <div class="result-card">
                                <div class="value">${data.win_rate?.toFixed(1) || 0}%</div>
                                <div class="label">Win Rate</div>
                            </div>
                            <div class="result-card">
                                <div class="value">${data.profit_factor?.toFixed(2) || 0}</div>
                                <div class="label">Profit Factor</div>
                            </div>
                            <div class="result-card">
                                <div class="value">${data.total_trades || 0}</div>
                                <div class="label">Total Trades</div>
                            </div>
                            <div class="result-card">
                                <div class="value" style="color: var(--accent-red)">-${data.max_drawdown?.toFixed(1) || 0}%</div>
                                <div class="label">Max Drawdown</div>
                            </div>
                            <div class="result-card">
                                <div class="value">$${data.expectancy?.toFixed(2) || 0}</div>
                                <div class="label">Expectancy</div>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="equity-chart"></canvas>
                        </div>
                        
                        <h4 style="margin: 1.5rem 0 1rem;">Recent Trades</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Direction</th>
                                    <th>Entry</th>
                                    <th>Exit</th>
                                    <th>Pips</th>
                                    <th>P&L</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${(data.trades || []).map(t => `
                                    <tr>
                                        <td>${t.date}</td>
                                        <td style="color: ${t.direction === 'LONG' ? 'var(--accent-green)' : 'var(--accent-red)'}">${t.direction}</td>
                                        <td>${t.entry}</td>
                                        <td>${t.exit}</td>
                                        <td style="color: ${t.pips >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">${t.pips >= 0 ? '+' : ''}${t.pips}</td>
                                        <td style="color: ${t.pnl >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">$${t.pnl}</td>
                                        <td><span class="status-badge ${t.result === 'WIN' ? 'ok' : 'error'}">${t.result}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    
                    // Draw equity curve
                    const ctx = document.getElementById('equity-chart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.equity_curve.map((_, i) => i + 1),
                            datasets: [{
                                label: 'Equity',
                                data: data.equity_curve,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { grid: { color: '#374151' } },
                                x: { grid: { color: '#374151' } }
                            }
                        }
                    });
                } else {
                    container.innerHTML = `<p style="color: var(--accent-red);">Backtest failed: ${data.error}</p>`;
                }
            } catch (error) {
                container.innerHTML = `<p style="color: var(--accent-red);">Error running backtest</p>`;
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TRADE JOURNAL FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        async function loadJournal() {
            // Load open trades
            const openContainer = document.getElementById('open-trades-list');
            const closedContainer = document.getElementById('closed-trades-list');
            
            try {
                // Open trades
                const openResp = await fetch(`${API_BASE}/journal?status=OPEN`);
                const openData = await openResp.json();
                
                if (openData.trades && openData.trades.length > 0) {
                    openContainer.innerHTML = openData.trades.map(t => `
                        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                            <div>
                                <strong style="color: ${t.direction === 'LONG' ? '#00ff88' : '#ff6666'};">${t.direction}</strong>
                                <span style="font-weight: 600;">${t.pair}</span>
                                <span style="color: var(--text-muted); font-size: 0.85rem;">@ ${t.entry_price}</span>
                                <span style="color: var(--text-muted); font-size: 0.85rem; margin-left: 0.5rem;">(${t.lot_size} lots)</span>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <input type="number" id="exit-price-${t.id}" placeholder="Exit Price" step="0.00001" style="padding: 0.3rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 0.3rem; color: var(--text-primary); width: 100px;">
                                <button onclick="closeTrade(${t.id}, 'WIN')" style="padding: 0.3rem 0.6rem; background: #00aa55; color: white; border: none; border-radius: 0.3rem; cursor: pointer; font-size: 0.8rem;">WIN</button>
                                <button onclick="closeTrade(${t.id}, 'LOSS')" style="padding: 0.3rem 0.6rem; background: #cc3333; color: white; border: none; border-radius: 0.3rem; cursor: pointer; font-size: 0.8rem;">LOSS</button>
                                <button onclick="closeTrade(${t.id}, 'BREAKEVEN')" style="padding: 0.3rem 0.6rem; background: #666; color: white; border: none; border-radius: 0.3rem; cursor: pointer; font-size: 0.8rem;">BE</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    openContainer.innerHTML = '<p style="color: var(--text-muted);">No open trades</p>';
                }
                
                // Closed trades
                const closedResp = await fetch(`${API_BASE}/journal?status=CLOSED&limit=20`);
                const closedData = await closedResp.json();
                
                if (closedData.trades && closedData.trades.length > 0) {
                    closedContainer.innerHTML = `
                        <table class="data-table" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Pair</th>
                                    <th>Direction</th>
                                    <th>Entry</th>
                                    <th>Exit</th>
                                    <th>P/L (pips)</th>
                                    <th>Outcome</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${closedData.trades.map(t => `
                                    <tr>
                                        <td>${new Date(t.timestamp_open).toLocaleDateString()}</td>
                                        <td>${t.pair}</td>
                                        <td style="color: ${t.direction === 'LONG' ? '#00ff88' : '#ff6666'};">${t.direction}</td>
                                        <td>${t.entry_price?.toFixed(5)}</td>
                                        <td>${t.exit_price?.toFixed(5)}</td>
                                        <td style="color: ${t.pnl_pips >= 0 ? '#00ff88' : '#ff6666'}; font-weight: 600;">${t.pnl_pips >= 0 ? '+' : ''}${t.pnl_pips?.toFixed(1)}</td>
                                        <td><span class="status-badge ${t.outcome === 'WIN' ? 'ok' : t.outcome === 'LOSS' ? 'error' : 'limited'}">${t.outcome}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    closedContainer.innerHTML = '<p style="color: var(--text-muted);">No closed trades yet</p>';
                }
            } catch (error) {
                console.error('Error loading journal:', error);
                openContainer.innerHTML = '<p style="color: var(--accent-red);">Error loading trades</p>';
            }
        }
        
        async function addTrade() {
            const tradeData = {
                pair: document.getElementById('journal-pair').value,
                direction: document.getElementById('journal-direction').value,
                lot_size: parseFloat(document.getElementById('journal-lots').value),
                entry_price: parseFloat(document.getElementById('journal-entry').value),
                sl_price: parseFloat(document.getElementById('journal-sl').value) || null,
                tp_price: parseFloat(document.getElementById('journal-tp').value) || null,
                notes: document.getElementById('journal-notes').value
            };
            
            if (!tradeData.entry_price) {
                alert('Please enter an entry price');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/journal/add`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(tradeData)
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Trade added successfully!');
                    document.getElementById('journal-entry').value = '';
                    document.getElementById('journal-sl').value = '';
                    document.getElementById('journal-tp').value = '';
                    document.getElementById('journal-notes').value = '';
                    loadJournal();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error adding trade: ' + error.message);
            }
        }
        
        async function closeTrade(tradeId, outcome) {
            const exitPrice = document.getElementById(`exit-price-${tradeId}`).value;
            
            if (!exitPrice) {
                alert('Please enter an exit price');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/journal/close/${tradeId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        exit_price: parseFloat(exitPrice),
                        outcome: outcome
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    alert(`Trade closed! P/L: ${data.pnl_pips} pips`);
                    loadJournal();
                    loadPerformance();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error closing trade: ' + error.message);
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PERFORMANCE FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        async function loadPerformance() {
            try {
                const response = await fetch(`${API_BASE}/performance`);
                const data = await response.json();
                
                if (data.success && data.overall) {
                    const o = data.overall;
                    
                    document.getElementById('perf-total-trades').textContent = o.total_trades || 0;
                    document.getElementById('perf-win-rate').textContent = (o.win_rate || 0).toFixed(1) + '%';
                    document.getElementById('perf-total-pips').textContent = (o.total_pips || 0).toFixed(1);
                    document.getElementById('perf-profit-factor').textContent = (o.profit_factor || 0).toFixed(2);
                    
                    document.getElementById('perf-wins').textContent = o.wins || 0;
                    document.getElementById('perf-losses').textContent = o.losses || 0;
                    document.getElementById('perf-best').textContent = (o.best_trade || 0).toFixed(1) + ' pips';
                    document.getElementById('perf-worst').textContent = (o.worst_trade || 0).toFixed(1) + ' pips';
                    document.getElementById('perf-avg-win').textContent = (o.avg_win || 0).toFixed(1);
                    document.getElementById('perf-avg-loss').textContent = (o.avg_loss || 0).toFixed(1);
                    
                    // Performance by pair
                    const byPairContainer = document.getElementById('perf-by-pair');
                    if (data.by_pair && data.by_pair.length > 0) {
                        byPairContainer.innerHTML = `
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr><th>Pair</th><th>Trades</th><th>Wins</th><th>Pips</th></tr>
                                </thead>
                                <tbody>
                                    ${data.by_pair.map(p => `
                                        <tr>
                                            <td>${p.pair}</td>
                                            <td>${p.trades}</td>
                                            <td>${p.wins}</td>
                                            <td style="color: ${p.pips >= 0 ? '#00ff88' : '#ff6666'}; font-weight: 600;">${p.pips >= 0 ? '+' : ''}${p.pips?.toFixed(1)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    } else {
                        byPairContainer.innerHTML = '<p style="color: var(--text-muted);">No trade data yet</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading performance:', error);
            }
        }
        
        // Run Audit
        async function runAudit() {
            const container = document.getElementById('audit-container');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Running audit...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/audit`);
                const data = await response.json();
                
                if (data.success) {
                    container.innerHTML = `
                        <div class="audit-section">
                            <h3>üîå API Status</h3>
                            <table class="data-table">
                                <thead>
                                    <tr><th>API</th><th>Status</th><th>Details</th></tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(data.api_status || {}).map(([name, info]) => `
                                        <tr>
                                            <td style="text-transform: capitalize;">${name}</td>
                                            <td><span class="status-badge ${info.status === 'OK' ? 'ok' : info.status === 'LIMITED' ? 'limited' : 'error'}">${info.status}</span></td>
                                            <td>${info.test_rate || info.test_value || info.articles || info.error || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="audit-section">
                            <h3>üìä Data Quality</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                <div class="result-card">
                                    <div class="value">${data.data_quality?.pairs_with_rates || 0}/${data.data_quality?.total_pairs || 45}</div>
                                    <div class="label">Pairs with Rates</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">${data.data_quality?.coverage || 0}%</div>
                                    <div class="label">Coverage</div>
                                </div>
                                <div class="result-card">
                                    <div class="value">${Object.keys(data.data_quality?.sources || {}).length}</div>
                                    <div class="label">Data Sources</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="audit-section">
                            <h3>‚úÖ Score Validation</h3>
                            <p>Test Pair: ${data.score_validation?.test_pair || 'N/A'}</p>
                            <p>Composite Score: ${data.score_validation?.composite_score || 'N/A'}</p>
                            <p>Direction: ${data.score_validation?.direction || 'N/A'}</p>
                            <p>Factors Available: ${data.score_validation?.factors_available || 0}</p>
                            <p>Trade Setup Valid: ${data.score_validation?.trade_setup_valid ? '‚úÖ Yes' : '‚ùå No'}</p>
                        </div>
                        
                        <p style="color: var(--text-muted); margin-top: 1rem;">Audit completed at: ${data.timestamp}</p>
                    `;
                }
            } catch (error) {
                container.innerHTML = `<p style="color: var(--accent-red);">Error running audit</p>`;
            }
        }
        
        // Load API Status
        async function loadApiStatus() {
            try {
                const response = await fetch(`${API_BASE}/api-status`);
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('api-status-container');
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            ${Object.entries(data).filter(([k]) => k !== 'success').map(([name, info]) => `
                                <div class="result-card">
                                    <div class="value">
                                        <span class="status-badge ${info.status === 'OK' ? 'ok' : info.status === 'NOT_CONFIGURED' ? 'limited' : 'error'}">
                                            ${info.status}
                                        </span>
                                    </div>
                                    <div class="label">${name.toUpperCase()}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem;">
                                        ${info.configured ? 'Configured' : 'Not Configured'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading API status:', error);
            }
        }
        
        // Filter listeners
        document.getElementById('filter-category').addEventListener('change', renderSignals);
        document.getElementById('filter-direction').addEventListener('change', renderSignals);
        document.getElementById('filter-score').addEventListener('change', renderSignals);
        document.getElementById('rates-category').addEventListener('change', loadRates);
        
        // Countdown timer
        function updateCountdown() {
            countdown--;
            if (countdown <= 0) {
                countdown = 120;
                loadSignals();
            }
            document.getElementById('refresh-countdown').textContent = `${countdown}s`;
        }
        
        // Initialize
        loadSignals();
        setInterval(updateCountdown, 1000);
    </script>
</body>
</html>
